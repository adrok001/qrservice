{% extends 'dashboard/base.html' %}
{% load static %}

{% block title %}Интеграции{% endblock %}
{% block page_title %}Интеграции{% endblock %}

{% block content %}
<div class="section">
    <div class="section-header">
        <h2 class="section-title">Подключённые платформы</h2>
    </div>

    <div class="integrations-grid">
        <!-- Google Business Profile -->
        <div class="integration-card">
            <div class="integration-header">
                <img src="{% static 'img/platforms/google.png' %}" alt="Google" class="integration-icon-img">
                <div class="integration-info">
                    <h3>Google Business</h3>
                    <p class="text-muted">Отзывы из Google Maps</p>
                </div>
            </div>

            {% with google_connection=connections|dictsort:"platform_id"|first %}
            {% if google_connection and google_connection.platform_id == 'google' %}
            <!-- Connected -->
            <div class="integration-status connected">
                <span class="status-dot success"></span>
                Подключено
            </div>

            <div class="integration-details">
                <p><strong>Аккаунт:</strong> {{ google_connection.google_account_id|default:"-" }}</p>
                <p><strong>Локация:</strong> {{ google_connection.google_location_id|default:"-" }}</p>
                <p>
                    <strong>Статус синхр.:</strong>
                    <span class="sync-status {{ google_connection.last_sync_status }}">
                        {{ google_connection.get_last_sync_status_display }}
                    </span>
                </p>
                {% if google_connection.last_sync %}
                <p><strong>Последняя синхр.:</strong> {{ google_connection.last_sync|timesince }} назад</p>
                {% endif %}
                {% if google_connection.last_sync_error %}
                <p class="error-text">{{ google_connection.last_sync_error }}</p>
                {% endif %}
            </div>

            <div class="integration-actions">
                <button class="btn btn-sm" onclick="syncNow('{{ google_connection.id }}')">
                    Синхронизировать
                </button>
                <form method="post" action="{% url 'integrations:google_disconnect' google_connection.id %}"
                      class="inline-form"
                      onsubmit="return confirm('Отключить Google Business?')">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-danger">Отключить</button>
                </form>
            </div>

            {% else %}
            <!-- Not connected -->
            <div class="integration-status">
                <span class="status-dot"></span>
                Не подключено
            </div>

            {% if google_configured %}
            <a href="{% url 'integrations:google_connect' %}" class="btn btn-primary">
                Подключить Google Business
            </a>
            {% else %}
            <div class="integration-notice">
                <p>Для подключения добавьте в <code>.env</code>:</p>
                <pre>GOOGLE_CLIENT_ID=...
GOOGLE_CLIENT_SECRET=...</pre>
                <a href="https://console.cloud.google.com/" target="_blank" class="link">
                    Получить в Google Cloud Console
                </a>
            </div>
            {% endif %}
            {% endif %}
            {% endwith %}
        </div>

        <!-- Yandex (placeholder) -->
        <div class="integration-card disabled">
            <div class="integration-header">
                <img src="{% static 'img/platforms/yandex.png' %}" alt="Яндекс" class="integration-icon-img">
                <div class="integration-info">
                    <h3>Яндекс Карты</h3>
                    <p class="text-muted">Нет открытого API</p>
                </div>
            </div>
            <div class="integration-status">
                <span class="status-dot"></span>
                Недоступно
            </div>
            <p class="text-muted text-sm">
                Яндекс не предоставляет публичный API для работы с отзывами.
                Управляйте отзывами через личный кабинет Яндекс.Бизнес.
            </p>
        </div>

        <!-- 2GIS (placeholder) -->
        <div class="integration-card disabled">
            <div class="integration-header">
                <img src="{% static 'img/platforms/2gis.png' %}" alt="2GIS" class="integration-icon-img">
                <div class="integration-info">
                    <h3>2GIS</h3>
                    <p class="text-muted">Нет API для отзывов</p>
                </div>
            </div>
            <div class="integration-status">
                <span class="status-dot"></span>
                Недоступно
            </div>
            <p class="text-muted text-sm">
                2GIS предоставляет только API для карт и поиска.
                API для отзывов недоступен.
            </p>
        </div>
    </div>
</div>

<!-- Telegram Notifications -->
<div class="section section-gap">
    <div class="section-header">
        <h2 class="section-title">Уведомления</h2>
    </div>

    <div class="integrations-grid">
        <div class="integration-card telegram-card">
            <div class="integration-header">
                <div class="integration-icon telegram">
                    <svg viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69a.2.2 0 00-.05-.18c-.06-.05-.14-.03-.21-.02-.09.02-1.49.95-4.22 2.79-.4.27-.76.41-1.08.4-.36-.01-1.04-.2-1.55-.37-.63-.2-1.12-.31-1.08-.66.02-.18.27-.36.74-.55 2.92-1.27 4.86-2.11 5.83-2.51 2.78-1.16 3.35-1.36 3.73-1.36.08 0 .27.02.39.12.1.08.13.19.14.27-.01.06.01.24 0 .38z"/>
                    </svg>
                </div>
                <div class="integration-info">
                    <h3>Telegram</h3>
                    <p class="text-muted">Уведомления о негативных отзывах</p>
                </div>
            </div>

            {% with tg=company.get_telegram_settings %}
            <form method="post" action="{% url 'integrations:telegram_save' %}" class="telegram-form">
                {% csrf_token %}

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" name="enabled" {% if tg.enabled %}checked{% endif %}>
                        Включить уведомления
                    </label>
                </div>

                <div class="form-group">
                    <label for="bot_token">Токен бота</label>
                    <input type="text" name="bot_token" id="bot_token" class="input"
                           value="{{ tg.bot_token }}"
                           placeholder="123456789:ABCdefGHIjklMNOpqrsTUVwxyz">
                    <p class="form-hint">Получите у <a href="https://t.me/BotFather" target="_blank">@BotFather</a></p>
                </div>

                <div class="form-group">
                    <label for="chat_id">Chat ID</label>
                    <input type="text" name="chat_id" id="chat_id" class="input"
                           value="{{ tg.chat_id }}"
                           placeholder="-1001234567890 или @channel">
                    <p class="form-hint">ID чата/группы или username канала. Узнать: <a href="https://t.me/getmyid_bot" target="_blank">@getmyid_bot</a></p>
                </div>

                <div class="form-actions-row">
                    <button type="submit" class="btn btn-primary">Сохранить</button>
                    <button type="button" class="btn btn-sm" onclick="testTelegram()">
                        Тест
                    </button>
                </div>
            </form>
            {% endwith %}
        </div>
    </div>
</div>


<script>
function testTelegram() {
    fetch('{% url "integrations:telegram_test" %}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
        } else {
            alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
        }
    })
    .catch(err => alert('Ошибка сети'));
}

function syncNow(connectionId) {
    fetch(`/integrations/google/${connectionId}/sync/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Синхронизация запущена. Обновите страницу через минуту.');
        } else {
            alert('Ошибка: ' + (data.error || 'Неизвестная ошибка'));
        }
    })
    .catch(err => alert('Ошибка сети'));
}
</script>
{% endblock %}
