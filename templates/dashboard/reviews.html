{% extends 'dashboard/base.html' %}
{% load static %}
{% load dashboard_filters %}

{% block title %}Отзывы{% endblock %}
{% block page_title %}Отзывы{% endblock %}

{% block content %}
<!-- Плашка фильтра по причине -->
{% if current_insight %}
<div class="insight-filter-badge">
    <span class="insight-filter-icon {% if current_insight_type == 'complaint' %}insight-filter-negative{% else %}insight-filter-positive{% endif %}">
        {% if current_insight_type == 'complaint' %}
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
            <circle cx="12" cy="12" r="10"/>
            <path d="M16 16s-1.5-2-4-2-4 2-4 2"/>
            <line x1="9" y1="9" x2="9.01" y2="9"/>
            <line x1="15" y1="9" x2="15.01" y2="9"/>
        </svg>
        {% else %}
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
            <circle cx="12" cy="12" r="10"/>
            <path d="M8 14s1.5 2 4 2 4-2 4-2"/>
            <line x1="9" y1="9" x2="9.01" y2="9"/>
            <line x1="15" y1="9" x2="15.01" y2="9"/>
        </svg>
        {% endif %}
    </span>
    <span class="insight-filter-label">
        {% if current_insight_type == 'complaint' %}Жалобы:{% else %}Похвалы:{% endif %}
    </span>
    <span class="insight-filter-value">{{ current_insight }}</span>
    <a href="{% url 'dashboard:reviews' %}" class="insight-filter-clear" title="Сбросить фильтр">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
            <line x1="18" y1="6" x2="6" y2="18"/>
            <line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
    </a>
</div>
{% endif %}

<!-- Фильтры -->
<div class="filters">
    <div class="filter-tabs">
        <a href="{% url 'dashboard:reviews' %}" class="filter-tab {% if current_filter == 'all' %}active{% endif %}">
            Все <span class="badge">{{ counts.all }}</span>
        </a>
        <a href="{% url 'dashboard:reviews' %}?filter=new" class="filter-tab {% if current_filter == 'new' %}active{% endif %}">
            Новые <span class="badge">{{ counts.new }}</span>
        </a>
        <a href="{% url 'dashboard:reviews' %}?filter=negative" class="filter-tab {% if current_filter == 'negative' %}active{% endif %}">
            Негатив <span class="badge badge-warning">{{ counts.negative }}</span>
        </a>
        <a href="{% url 'dashboard:reviews' %}?filter=no_response" class="filter-tab {% if current_filter == 'no_response' %}active{% endif %}">
            Без ответа <span class="badge">{{ counts.no_response }}</span>
        </a>
        {% if counts.complex %}
        <a href="{% url 'dashboard:reviews' %}?filter=complex" class="filter-tab {% if current_filter == 'complex' %}active{% endif %}">
            На проверку <span class="badge">{{ counts.complex }}</span>
        </a>
        {% endif %}
    </div>

    <div class="filter-row">
        <select class="select" onchange="updateFilters('source', this.value)">
            <option value="">Все источники</option>
            <option value="internal" {% if current_source == 'internal' %}selected{% endif %}>Наш сервис</option>
            <option value="yandex" {% if current_source == 'yandex' %}selected{% endif %}>Яндекс</option>
            <option value="2gis" {% if current_source == '2gis' %}selected{% endif %}>2GIS</option>
            <option value="google" {% if current_source == 'google' %}selected{% endif %}>Google</option>
        </select>

        <select class="select" onchange="updateFilters('sentiment', this.value)">
            <option value="">Все тональности</option>
            <option value="positive" {% if current_sentiment == 'positive' %}selected{% endif %}>Позитивный</option>
            <option value="neutral" {% if current_sentiment == 'neutral' %}selected{% endif %}>Нейтральный</option>
            <option value="negative" {% if current_sentiment == 'negative' %}selected{% endif %}>Негативный</option>
        </select>

        <select class="select" onchange="updateFilters('category', this.value)">
            <option value="">Все категории</option>
            <option value="Безопасность" {% if current_category == 'Безопасность' %}selected{% endif %}>Безопасность</option>
            <option value="Сервис" {% if current_category == 'Сервис' %}selected{% endif %}>Сервис</option>
            <option value="Скорость" {% if current_category == 'Скорость' %}selected{% endif %}>Скорость</option>
            <option value="Продукт" {% if current_category == 'Продукт' %}selected{% endif %}>Продукт</option>
            <option value="Цена" {% if current_category == 'Цена' %}selected{% endif %}>Цена</option>
            <option value="Комфорт" {% if current_category == 'Комфорт' %}selected{% endif %}>Комфорт</option>
            <option value="Процесс" {% if current_category == 'Процесс' %}selected{% endif %}>Процесс</option>
            <option value="Общее" {% if current_category == 'Общее' %}selected{% endif %}>Общее</option>
            <option value="complex" {% if current_category == 'complex' %}selected{% endif %}>Сложный отзыв</option>
        </select>

        <form class="search-form" method="get">
            <input type="text" name="search" class="input" placeholder="Поиск..." value="{{ search }}">
        </form>
    </div>
</div>

<!-- Список отзывов -->
<div class="reviews-list">
    {% for review in reviews %}
    <div class="review-card-new {% if review.rating <= 3 %}review-card-negative{% endif %}">
        <!-- Шапка: иконка платформы, автор, дата -->
        <div class="review-header-new">
            <div class="review-platform-icon">
                {% if review.source == 'yandex' %}
                <img src="{% static 'img/platforms/yandex.png' %}" alt="Яндекс" class="platform-icon">
                {% elif review.source == '2gis' %}
                <img src="{% static 'img/platforms/2gis.png' %}" alt="2GIS" class="platform-icon">
                {% elif review.source == 'google' %}
                <img src="{% static 'img/platforms/google.png' %}" alt="Google" class="platform-icon">
                {% else %}
                <img src="{% static 'img/platforms/internal.png' %}" alt="Наш сервис" class="platform-icon">
                {% endif %}
            </div>
            <div class="review-meta-new">
                <div class="review-author-line">
                    {% if review.author_contact and review.source != 'internal' %}<a href="{{ review.author_contact }}" target="_blank" class="review-author-name" title="Профиль на платформе">{{ review.author_name }}</a>{% else %}<span class="review-author-name">{{ review.author_name }}</span>{% endif %}
                    <span class="review-date-new">{% if review.platform_date %}{{ review.platform_date|date:"d.m.Y, H:i" }}{% else %}{{ review.created_at|date:"d.m.Y, H:i" }}{% endif %}</span>
                    {% if review.external_url %}
                    <a href="{{ review.external_url }}" target="_blank" class="review-external-link" title="Открыть на платформе">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                    </a>
                    {% endif %}
                </div>
                <div class="review-rating-line">
                    <div class="review-stars">{% for i in "12345" %}<span class="star {% if forloop.counter <= review.rating %}active{% endif %}">★</span>{% endfor %}</div>
                    <span class="review-sentiment-badge sentiment-{{ review.sentiment }}">
                        {{ review.get_sentiment_display }}
                    </span>
                    {% if review.wants_contact %}
                    <span class="review-badge-contact">Ждёт ответа</span>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Текст отзыва -->
        {% if review.text %}
        <div class="review-text-new" {% if review.tags and not review.tags_complex %}data-tags='{{ review.tags|to_json }}'{% endif %}>{{ review.text|linebreaksbr }}</div>
        {% endif %}

        <!-- Фото -->
        {% if review.photo or review.photos.exists %}
        <div class="review-photos">
            {% if review.photo %}
            <div class="review-photo" onclick="openLightbox('{{ review.photo.url }}')">
                <img src="{{ review.photo.url }}" alt="Фото отзыва">
            </div>
            {% endif %}
            {% for photo in review.photos.all %}
            <div class="review-photo" onclick="openLightbox('{{ photo.image.url }}')">
                <img src="{{ photo.image.url }}" alt="Фото отзыва">
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Адрес точки -->
        {% if review.spot or company.address %}
        <div class="review-location">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></svg>
            <span>{% if review.spot %}{{ review.spot.name }}{% if review.spot.address %}, {{ review.spot.address }}{% endif %}{% else %}{{ company.address }}{% endif %}</span>
        </div>
        {% endif %}

        <!-- Категории/аспекты из tags -->
        {% if review.tags_complex %}
        <div class="review-aspects" id="aspects-{{ review.id }}">
            <button class="manual-tag-btn" onclick="showTagForm('{{ review.id }}')">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                Укажите категорию
            </button>
            <div class="manual-tag-form" id="tag-form-{{ review.id }}" style="display:none">
                <div class="manual-tag-selects">
                    <select class="manual-tag-select" id="cat-{{ review.id }}" onchange="updateSubcats('{{ review.id }}')">
                        <option value="">Категория</option>
                    </select>
                    <select class="manual-tag-select" id="subcat-{{ review.id }}" disabled>
                        <option value="">Подкатегория</option>
                    </select>
                    <select class="manual-tag-select manual-tag-sentiment" id="sent-{{ review.id }}" disabled>
                        <option value="">+/−</option>
                        <option value="negative">Негатив</option>
                        <option value="positive">Позитив</option>
                    </select>
                    <button class="manual-tag-add" onclick="addManualTag('{{ review.id }}')" title="Добавить">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                    </button>
                </div>
                <div class="manual-tag-list" id="tag-list-{{ review.id }}"></div>
                <div class="manual-tag-actions" id="tag-actions-{{ review.id }}" style="display:none">
                    <button class="manual-tag-save" onclick="saveManualTags('{{ review.id }}')">Сохранить</button>
                </div>
            </div>
        </div>
        {% elif review.tags %}
        <div class="review-aspects">
            {% for tag in review.tags %}
            {% if tag.category %}
            <span class="aspect-tag aspect-{{ tag.sentiment }}" data-tag-index="{{ forloop.counter0 }}">
                {{ tag.subcategory|default:tag.category }}
            </span>
            {% endif %}
            {% endfor %}
        </div>
        {% endif %}


        <!-- Блок ответа -->
        <div class="review-response-section">
            {% if review.response %}
            <div class="review-response-existing">
                <div class="response-header-new">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"/></svg>
                    <span>Ваш ответ</span>
                    <span class="response-date">{{ review.response_at|date:"d.m.Y H:i" }}</span>
                </div>
                <div class="response-text-new">{{ review.response }}</div>
            </div>
            {% elif can_respond %}
            <form class="response-form-new" data-review-id="{{ review.id }}">
                <div class="response-input-wrapper">
                    <textarea class="response-textarea" placeholder="Напишите ответ на отзыв..." rows="2"></textarea>
                    <button type="submit" class="btn-respond">Ответить</button>
                </div>
            </form>
            {% endif %}
        </div>

        <!-- История -->
        <div class="review-history-section">
            <button type="button" class="history-toggle" data-review-id="{{ review.id }}">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                История {% if review.history.count > 0 %}({{ review.history.count }}){% endif %}
            </button>
            <div class="history-content hidden" id="history-{{ review.id }}">
                {% for item in review.history.all %}
                <div class="history-item">
                    <span class="history-date">{{ item.created_at|date:"d.m.Y H:i" }}</span>
                    <span class="history-action">{{ item.get_action_display }}</span>
                    {% if item.user %}<span class="history-user">({{ item.user.get_full_name|default:item.user.email }})</span>{% endif %}
                    {% if item.description %}<span class="history-desc">— {{ item.description }}</span>{% endif %}
                </div>
                {% empty %}
                <div class="history-empty">История пуста</div>
                {% endfor %}
            </div>
        </div>
    </div>
    {% empty %}
    <div class="empty-state">
        <svg class="icon-empty-state" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
        <p>Нет отзывов по выбранным фильтрам</p>
    </div>
    {% endfor %}
</div>

<!-- Лайтбокс для фото -->
<div class="photo-lightbox" id="photo-lightbox" onclick="if(event.target===this)closeLightbox()">
    <button class="photo-lightbox-close" onclick="closeLightbox()">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
    </button>
    <img src="" alt="Фото отзыва">
</div>

<script>
// Обновление фильтров с сохранением остальных параметров
function updateFilters(param, value) {
    const url = new URL(window.location.href);
    if (value) {
        url.searchParams.set(param, value);
    } else {
        url.searchParams.delete(param);
    }
    window.location.href = url.toString();
}

// Отправка ответа
document.querySelectorAll('.response-form-new').forEach(form => {
    form.addEventListener('submit', async function(e) {
        e.preventDefault();
        const reviewId = this.dataset.reviewId;
        const textarea = this.querySelector('textarea');
        const response = textarea.value.trim();

        if (!response) return;

        const btn = this.querySelector('button');
        btn.disabled = true;
        btn.textContent = 'Отправка...';

        try {
            const res = await fetch(`/api/reviews/${reviewId}/respond/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ response })
            });

            const data = await res.json();

            if (res.ok && data.success) {
                location.reload();
            } else {
                alert('Ошибка: ' + (data.error || res.status));
                btn.disabled = false;
                btn.textContent = 'Ответить';
            }
        } catch (err) {
            alert('Ошибка сети: ' + err.message);
            btn.disabled = false;
            btn.textContent = 'Ответить';
        }
    });
});

// Раскрытие истории
document.querySelectorAll('.history-toggle').forEach(btn => {
    btn.addEventListener('click', function() {
        const reviewId = this.dataset.reviewId;
        const content = document.getElementById('history-' + reviewId);
        const isHidden = content.classList.contains('hidden');

        content.classList.toggle('hidden');
        this.classList.toggle('active');

        // Поворот стрелки
        const svg = this.querySelector('svg');
        svg.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';
    });
});

/* === Лайтбокс для фото === */
function openLightbox(url) {
    var lb = document.getElementById('photo-lightbox');
    lb.querySelector('img').src = url;
    lb.classList.add('active');
    document.body.style.overflow = 'hidden';
}
function closeLightbox() {
    var lb = document.getElementById('photo-lightbox');
    lb.classList.remove('active');
    lb.querySelector('img').src = '';
    document.body.style.overflow = '';
}
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') closeLightbox();
});

/* === Подсветка слов в тексте отзыва по тегам === */
document.querySelectorAll('.review-text-new[data-tags]').forEach(function(textEl) {
    var tags;
    try { tags = JSON.parse(textEl.dataset.tags); } catch(e) { return; }
    if (!tags || !tags.length) return;

    // Собираем слова для подсветки: {word, sentiment, tagIndex}
    var items = [];
    tags.forEach(function(tag, idx) {
        var sentiment = tag.sentiment || 'neutral';
        if (tag.marker && tag.marker !== '-') {
            items.push({word: tag.marker, sentiment: sentiment, idx: idx});
        }
        (tag.evidence || []).forEach(function(ev) {
            items.push({word: ev, sentiment: sentiment, idx: idx});
        });
    });
    if (!items.length) return;

    // Сортируем по длине (длинные фразы первыми, чтобы "не вкусно" матчилось раньше "вкусно")
    items.sort(function(a, b) { return b.word.length - a.word.length; });

    // Строим regex: граница слова для кириллицы
    var html = textEl.innerHTML;
    var used = []; // маска уже подсвеченных позиций
    items.forEach(function(item) {
        var escaped = item.word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        var re = new RegExp('(?<![а-яёА-ЯЁ])(' + escaped + ')(?![а-яёА-ЯЁ])', 'gi');
        html = html.replace(re, function(match, p1, offset, str) {
            // Не подсвечивать внутри тегов
            var before = str.substring(0, offset);
            var openTags = (before.match(/<[^/][^>]*>/g) || []).length;
            var closeTags = (before.match(/<\/[^>]*>/g) || []).length;
            if (openTags > closeTags) return match;
            return '<span class="highlight highlight-' + item.sentiment + '" data-tag-index="' + item.idx + '">' + p1 + '</span>';
        });
    });
    textEl.innerHTML = html;
});

// Hover на тегах — яркая подсветка
document.querySelectorAll('.aspect-tag[data-tag-index]').forEach(function(tag) {
    var card = tag.closest('.review-card-new');
    if (!card) return;
    var idx = tag.dataset.tagIndex;

    tag.addEventListener('mouseenter', function() {
        card.querySelectorAll('.highlight[data-tag-index="' + idx + '"]').forEach(function(hl) {
            hl.classList.add('highlight-active');
        });
    });
    tag.addEventListener('mouseleave', function() {
        card.querySelectorAll('.highlight[data-tag-index="' + idx + '"]').forEach(function(hl) {
            hl.classList.remove('highlight-active');
        });
    });
});

/* === Ручная маркировка сложных отзывов === */
var CATEGORIES = {
    "Безопасность": ["Пищевая безопасность"],
    "Сервис": ["Сервис в целом", "Вежливость персонала", "Внимательность персонала", "Знание меню", "Решение проблем", "Тон общения"],
    "Скорость": ["Скорость обслуживания"],
    "Продукт": ["Качество блюд", "Напитки", "Свежесть продуктов", "Размер порций"],
    "Цена": ["Цены"],
    "Комфорт": ["Атмосфера и интерьер", "Чистота"],
    "Процесс": ["Бронирование и посадка", "Точность заказа", "Расчёт с гостем", "Доставка и вынос"]
};
var pendingTags = {};

function showTagForm(reviewId) {
    var form = document.getElementById('tag-form-' + reviewId);
    var btn = form.previousElementSibling;
    btn.style.display = 'none';
    form.style.display = 'block';
    pendingTags[reviewId] = [];

    var catSelect = document.getElementById('cat-' + reviewId);
    catSelect.innerHTML = '<option value="">Категория</option>';
    Object.keys(CATEGORIES).forEach(function(cat) {
        catSelect.innerHTML += '<option value="' + cat + '">' + cat + '</option>';
    });
}

function updateSubcats(reviewId) {
    var cat = document.getElementById('cat-' + reviewId).value;
    var subSelect = document.getElementById('subcat-' + reviewId);
    var sentSelect = document.getElementById('sent-' + reviewId);

    subSelect.innerHTML = '<option value="">Подкатегория</option>';
    if (cat && CATEGORIES[cat]) {
        CATEGORIES[cat].forEach(function(sub) {
            subSelect.innerHTML += '<option value="' + sub + '">' + sub + '</option>';
        });
        subSelect.disabled = false;
        sentSelect.disabled = false;
    } else {
        subSelect.disabled = true;
        sentSelect.disabled = true;
    }
}

function addManualTag(reviewId) {
    var cat = document.getElementById('cat-' + reviewId).value;
    var sub = document.getElementById('subcat-' + reviewId).value;
    var sent = document.getElementById('sent-' + reviewId).value;

    if (!cat || !sub || !sent) return;

    // Проверка дубликата
    if (pendingTags[reviewId].some(function(t) { return t.category === cat && t.subcategory === sub; })) return;

    pendingTags[reviewId].push({ category: cat, subcategory: sub, sentiment: sent });

    var list = document.getElementById('tag-list-' + reviewId);
    var tagEl = document.createElement('span');
    tagEl.className = 'aspect-tag aspect-' + sent;
    tagEl.innerHTML = sub + ' <span class="manual-tag-remove" onclick="removeManualTag(\'' + reviewId + '\',' + (pendingTags[reviewId].length - 1) + ',this)">&times;</span>';
    list.appendChild(tagEl);

    document.getElementById('tag-actions-' + reviewId).style.display = 'flex';

    // Сброс селектов
    document.getElementById('cat-' + reviewId).value = '';
    document.getElementById('subcat-' + reviewId).innerHTML = '<option value="">Подкатегория</option>';
    document.getElementById('subcat-' + reviewId).disabled = true;
    document.getElementById('sent-' + reviewId).value = '';
    document.getElementById('sent-' + reviewId).disabled = true;
}

function removeManualTag(reviewId, index, el) {
    pendingTags[reviewId].splice(index, 1);
    el.parentElement.remove();
    if (pendingTags[reviewId].length === 0) {
        document.getElementById('tag-actions-' + reviewId).style.display = 'none';
    }
}

function saveManualTags(reviewId) {
    if (!pendingTags[reviewId] || pendingTags[reviewId].length === 0) return;

    var saveBtn = document.querySelector('#tag-actions-' + reviewId + ' .manual-tag-save');
    saveBtn.textContent = 'Сохраняю...';
    saveBtn.disabled = true;

    fetch('/api/reviews/' + reviewId + '/tag/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({ tags: pendingTags[reviewId] })
    })
    .then(function(res) { return res.json(); })
    .then(function(data) {
        if (data.success) {
            var container = document.getElementById('aspects-' + reviewId);
            container.innerHTML = '';
            data.tags.forEach(function(tag) {
                var el = document.createElement('span');
                el.className = 'aspect-tag aspect-' + tag.sentiment;
                el.textContent = tag.subcategory;
                container.appendChild(el);
            });
        } else {
            saveBtn.textContent = 'Ошибка';
            saveBtn.disabled = false;
        }
    })
    .catch(function() {
        saveBtn.textContent = 'Ошибка сети';
        saveBtn.disabled = false;
    });
}
</script>
{% endblock %}
