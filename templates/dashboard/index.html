{% extends 'dashboard/base.html' %}

{% block title %}Обзор{% endblock %}
{% block page_title %}Обзор{% endblock %}

{% block content %}
<!-- Фильтры по периоду -->
<div class="period-filters">
    <a href="?period=week" class="period-btn {% if period == 'week' %}active{% endif %}" data-tooltip="{{ period_labels.week }}">Неделя</a>
    <a href="?period=month" class="period-btn {% if period == 'month' %}active{% endif %}" data-tooltip="{{ period_labels.month }}">Месяц</a>
    <a href="?period=quarter" class="period-btn {% if period == 'quarter' %}active{% endif %}" data-tooltip="{{ period_labels.quarter }}">Квартал</a>
    <a href="?period=half_year" class="period-btn {% if period == 'half_year' %}active{% endif %}" data-tooltip="{{ period_labels.half_year }}">6 месяцев</a>
    <button type="button" class="period-btn {% if period == 'custom' %}active{% endif %}" id="customPeriodBtn">
        {% if period == 'custom' and date_from and date_to %}
            {{ date_from }} — {{ date_to }}
        {% else %}
            Произвольный
        {% endif %}
    </button>
</div>

<!-- Модальное окно выбора периода -->
<div class="modal-overlay" id="periodModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Выберите период</h3>
            <button type="button" class="modal-close" id="closeModal">&times;</button>
        </div>
        <form method="get" class="period-form">
            <input type="hidden" name="period" value="custom">
            <div class="form-row">
                <div class="form-group">
                    <label for="date_from">С</label>
                    <input type="date" id="date_from" name="date_from" value="{{ date_from|default:'' }}" required>
                </div>
                <div class="form-group">
                    <label for="date_to">По</label>
                    <input type="date" id="date_to" name="date_to" value="{{ date_to|default:'' }}" required>
                </div>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" id="cancelModal">Отмена</button>
                <button type="submit" class="btn btn-primary">Применить</button>
            </div>
        </form>
    </div>
</div>

<!-- Ключевые метрики (6 KPI) -->
<section class="section">
    <h2 class="section-title">Ключевые метрики</h2>
    <div class="metrics-grid metrics-grid-6">
        <!-- 1. Средний рейтинг -->
        <div class="metric-card">
            <div class="metric-label">Средний рейтинг</div>
            <div class="metric-value">{{ analytics.avg_rating }}</div>
            {% if analytics.avg_rating_delta is not None %}
                <div class="metric-delta {% if analytics.avg_rating_delta > 0 %}delta-positive{% elif analytics.avg_rating_delta < 0 %}delta-negative{% endif %}">
                    {% if analytics.avg_rating_delta > 0 %}
                        <svg class="delta-arrow" viewBox="0 0 12 12"><path d="M6 2L11 8H1L6 2Z"/></svg>+{{ analytics.avg_rating_delta }}
                    {% elif analytics.avg_rating_delta < 0 %}
                        <svg class="delta-arrow" viewBox="0 0 12 12"><path d="M6 10L1 4H11L6 10Z"/></svg>{{ analytics.avg_rating_delta }}
                    {% else %}
                        0
                    {% endif %}
                </div>
            {% endif %}
            <div class="metric-stars">
                {% for i in "12345" %}
                    <span class="star {% if forloop.counter <= analytics.avg_rating %}active{% endif %}">★</span>
                {% endfor %}
            </div>
        </div>

        <!-- 2. NPS -->
        <div class="metric-card">
            <div class="metric-label">NPS / Индекс лояльности</div>
            <div class="metric-value {% if analytics.nps >= 50 %}text-green{% elif analytics.nps >= 0 %}text-yellow{% else %}text-red{% endif %}">{{ analytics.nps }}</div>
            {% if analytics.nps_delta is not None %}
                <div class="metric-delta {% if analytics.nps_delta > 0 %}delta-positive{% elif analytics.nps_delta < 0 %}delta-negative{% endif %}">
                    {% if analytics.nps_delta > 0 %}
                        <svg class="delta-arrow" viewBox="0 0 12 12"><path d="M6 2L11 8H1L6 2Z"/></svg>+{{ analytics.nps_delta }}
                    {% elif analytics.nps_delta < 0 %}
                        <svg class="delta-arrow" viewBox="0 0 12 12"><path d="M6 10L1 4H11L6 10Z"/></svg>{{ analytics.nps_delta }}
                    {% else %}
                        0
                    {% endif %}
                </div>
            {% endif %}
            <div class="metric-hint">от -100 до +100</div>
        </div>

        <!-- 3. Доля негатива -->
        <div class="metric-card {% if analytics.negative_share > 20 %}metric-warning{% endif %}">
            <div class="metric-label">Доля негатива</div>
            <div class="metric-value">{{ analytics.negative_share }}%</div>
            <div class="metric-hint">{{ analytics.sentiment_counts.negative }} из {{ analytics.total_count }}</div>
        </div>

        <!-- 4. Негатив без ответа -->
        <div class="metric-card {% if analytics.negative_unanswered_count > 0 %}metric-warning{% endif %}">
            <div class="metric-label">Негатив без ответа</div>
            <div class="metric-value">{{ analytics.negative_unanswered_count }}</div>
            <div class="metric-hint">{{ analytics.negative_unanswered_share }}% от негатива</div>
        </div>

        <!-- 5. Среднее время ответа -->
        <div class="metric-card">
            <div class="metric-label">Время ответа (ср.)</div>
            <div class="metric-value">{{ analytics.avg_response_time_hours }}ч</div>
            <div class="metric-hint">по отзывам с ответом</div>
        </div>

        <!-- 6. Риск репутации -->
        <div class="metric-card {% if analytics.reputation_risk >= 50 %}metric-danger{% elif analytics.reputation_risk >= 30 %}metric-warning{% endif %}">
            <div class="metric-label">Риск репутации</div>
            <div class="metric-value">{{ analytics.reputation_risk }}</div>
            <div class="metric-progress">
                <div class="progress-bar {% if analytics.reputation_risk >= 50 %}progress-danger{% elif analytics.reputation_risk >= 30 %}progress-warning{% else %}progress-ok{% endif %}" style="--progress-width: {{ analytics.reputation_risk }}%"></div>
            </div>
            <div class="metric-hint">шкала 0–100</div>
        </div>
    </div>
</section>

<!-- Графики -->
<section class="section">
    <h2 class="section-title">Аналитика</h2>
    <div class="charts-grid">
        <!-- По рейтингу -->
        <div class="chart-card">
            <div class="chart-header">
                <span class="chart-title">По рейтингу</span>
            </div>
            <div class="chart-container">
                <canvas id="ratingChart"></canvas>
            </div>
            <div class="chart-legend" id="ratingLegend"></div>
        </div>

        <!-- Карта впечатлений (По аспектам) -->
        <div class="chart-card">
            <div class="chart-header">
                <span class="chart-title">По аспектам</span>
            </div>
            <div class="chart-container aspect-chart-container">
                <canvas id="aspectChart"></canvas>
                <div class="aspect-center" id="aspectCenter">
                    <div class="aspect-center-category">Всего</div>
                    <div class="aspect-center-count">Отзывов: <span id="aspectTotalCount">0</span></div>
                    <div class="aspect-center-sentiment">
                        <span class="sentiment-positive" id="aspectPositive">0</span>
                        <span class="sentiment-divider">|</span>
                        <span class="sentiment-negative" id="aspectNegative">0</span>
                    </div>
                </div>
            </div>
            <div class="chart-legend" id="aspectLegend"></div>
        </div>

        <!-- По источникам -->
        <div class="chart-card">
            <div class="chart-header">
                <span class="chart-title">По источникам</span>
            </div>
            <div class="chart-container">
                <canvas id="sourceChart"></canvas>
            </div>
            <div class="chart-legend" id="sourceLegend"></div>
        </div>

        <!-- По дням -->
        <div class="chart-card chart-card-wide">
            <div class="chart-header">
                <span class="chart-title">Динамика отзывов</span>
            </div>
            <div class="chart-container chart-container-bar">
                <canvas id="dailyChart"></canvas>
            </div>
        </div>
    </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const analyticsData = {{ analytics_json|safe }};

    // Хелпер для чтения CSS-переменных
    const getCSSVar = (name) => getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    const chartColors = [
        getCSSVar('--chart-color-1'), getCSSVar('--chart-color-2'),
        getCSSVar('--chart-color-3'), getCSSVar('--chart-color-4'),
        getCSSVar('--chart-color-5'), getCSSVar('--chart-color-6'),
        getCSSVar('--chart-color-7'), getCSSVar('--chart-color-8')
    ];
    const primaryColor = getCSSVar('--color-primary');
    const whiteColor = getCSSVar('--color-white');

    // Данные карты впечатлений
    const impressionData = [
        {% for item in impression_map %}
        {
            category: "{{ item.category }}",
            total: {{ item.total }},
            positive: {{ item.positive }},
            negative: {{ item.negative }},
            neutral: {{ item.neutral }}
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];

    // Общие настройки для donut-чартов
    const doughnutOptions = {
        cutout: '65%',
        plugins: {
            legend: { display: false }
        },
        maintainAspectRatio: false
    };

    // График по рейтингу
    if (analyticsData.rating_data.values.some(v => v > 0)) {
        const ratingCtx = document.getElementById('ratingChart').getContext('2d');
        new Chart(ratingCtx, {
            type: 'doughnut',
            data: {
                labels: analyticsData.rating_data.labels,
                datasets: [{
                    data: analyticsData.rating_data.values,
                    backgroundColor: analyticsData.rating_data.colors,
                    borderWidth: 0
                }]
            },
            options: doughnutOptions
        });

        // Легенда для рейтинга
        const ratingLegend = document.getElementById('ratingLegend');
        const total = analyticsData.rating_data.values.reduce((a, b) => a + b, 0);
        analyticsData.rating_data.labels.forEach((label, i) => {
            const value = analyticsData.rating_data.values[i];
            const percent = total > 0 ? Math.round(value / total * 100) : 0;
            if (value > 0) {
                ratingLegend.innerHTML += `
                    <div class="legend-item">
                        <span class="legend-color" style="background: ${analyticsData.rating_data.colors[i]}"></span>
                        <span class="legend-percent">${percent}%</span>
                        <span class="legend-label">${label}</span>
                    </div>
                `;
            }
        });
    } else {
        document.getElementById('ratingChart').parentElement.innerHTML = '<div class="chart-empty">Нет данных</div>';
    }

    // График по аспектам (Карта впечатлений)
    if (impressionData.length > 0) {
        const aspectColors = chartColors;
        const aspectLabels = impressionData.map(d => d.category);
        const aspectValues = impressionData.map(d => d.total);
        const aspectTotals = impressionData.reduce((sum, d) => sum + d.total, 0);
        const totalPositive = impressionData.reduce((sum, d) => sum + d.positive, 0);
        const totalNegative = impressionData.reduce((sum, d) => sum + d.negative, 0);

        // Обновляем центр по умолчанию
        document.getElementById('aspectTotalCount').textContent = aspectTotals;
        document.getElementById('aspectPositive').textContent = totalPositive;
        document.getElementById('aspectNegative').textContent = totalNegative;

        const aspectCtx = document.getElementById('aspectChart').getContext('2d');
        const aspectChart = new Chart(aspectCtx, {
            type: 'doughnut',
            data: {
                labels: aspectLabels,
                datasets: [{
                    data: aspectValues,
                    backgroundColor: aspectColors.slice(0, aspectLabels.length),
                    borderWidth: 0,
                    hoverBorderWidth: 3,
                    hoverBorderColor: whiteColor
                }]
            },
            options: {
                cutout: '70%',
                plugins: {
                    legend: { display: false },
                    tooltip: { enabled: false }
                },
                maintainAspectRatio: false,
                onHover: (event, elements) => {
                    const centerCategory = document.querySelector('.aspect-center-category');
                    const centerCount = document.getElementById('aspectTotalCount');
                    const centerPositive = document.getElementById('aspectPositive');
                    const centerNegative = document.getElementById('aspectNegative');

                    if (elements.length > 0) {
                        const idx = elements[0].index;
                        const item = impressionData[idx];
                        centerCategory.textContent = item.category;
                        centerCount.textContent = item.total;
                        centerPositive.textContent = item.positive;
                        centerNegative.textContent = item.negative;
                    } else {
                        centerCategory.textContent = 'Всего';
                        centerCount.textContent = aspectTotals;
                        centerPositive.textContent = totalPositive;
                        centerNegative.textContent = totalNegative;
                    }
                }
            }
        });

        // Легенда для аспектов
        const aspectLegend = document.getElementById('aspectLegend');
        aspectLabels.forEach((label, i) => {
            const value = aspectValues[i];
            const percent = aspectTotals > 0 ? Math.round(value / aspectTotals * 100) : 0;
            aspectLegend.innerHTML += `
                <div class="legend-item" data-index="${i}">
                    <span class="legend-color" style="background: ${aspectColors[i]}"></span>
                    <span class="legend-percent">${percent}%</span>
                    <span class="legend-label">${label}</span>
                </div>
            `;
        });
    } else {
        document.getElementById('aspectChart').parentElement.innerHTML = '<div class="chart-empty">Нет данных</div>';
    }

    // График по источникам
    if (analyticsData.source_data.values.length > 0) {
        const sourceCtx = document.getElementById('sourceChart').getContext('2d');
        new Chart(sourceCtx, {
            type: 'doughnut',
            data: {
                labels: analyticsData.source_data.labels,
                datasets: [{
                    data: analyticsData.source_data.values,
                    backgroundColor: analyticsData.source_data.colors,
                    borderWidth: 0
                }]
            },
            options: doughnutOptions
        });

        // Легенда для источников
        const sourceLegend = document.getElementById('sourceLegend');
        const sourceTotal = analyticsData.source_data.values.reduce((a, b) => a + b, 0);
        analyticsData.source_data.labels.forEach((label, i) => {
            const value = analyticsData.source_data.values[i];
            const percent = sourceTotal > 0 ? Math.round(value / sourceTotal * 100) : 0;
            sourceLegend.innerHTML += `
                <div class="legend-item">
                    <span class="legend-color" style="background: ${analyticsData.source_data.colors[i]}"></span>
                    <span class="legend-percent">${percent}%</span>
                    <span class="legend-label">${label}</span>
                </div>
            `;
        });
    } else {
        document.getElementById('sourceChart').parentElement.innerHTML = '<div class="chart-empty">Нет данных</div>';
    }

    // График по дням (линейный)
    if (analyticsData.daily_data.values.some(v => v > 0)) {
        const dailyCtx = document.getElementById('dailyChart').getContext('2d');

        new Chart(dailyCtx, {
            type: 'line',
            data: {
                labels: analyticsData.daily_data.labels,
                datasets: [{
                    data: analyticsData.daily_data.values,
                    borderColor: primaryColor,
                    backgroundColor: 'rgba(0, 0, 0, 0.05)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.3,
                    pointRadius: 4,
                    pointBackgroundColor: primaryColor,
                    pointBorderColor: whiteColor,
                    pointBorderWidth: 2,
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            stepSize: 1,
                            font: { size: 12 }
                        },
                        grid: { color: 'rgba(0,0,0,0.05)' }
                    },
                    x: {
                        grid: { display: false },
                        ticks: {
                            font: { size: 11 },
                            maxRotation: 0,
                            autoSkip: true,
                            maxTicksLimit: 15
                        }
                    }
                }
            }
        });
    } else {
        document.getElementById('dailyChart').parentElement.innerHTML = '<div class="chart-empty">Нет данных за период</div>';
    }

    // Модальное окно выбора периода
    const modal = document.getElementById('periodModal');
    const openBtn = document.getElementById('customPeriodBtn');
    const closeBtn = document.getElementById('closeModal');
    const cancelBtn = document.getElementById('cancelModal');

    function openModal() {
        modal.classList.add('active');
    }

    function closeModal() {
        modal.classList.remove('active');
    }

    openBtn.addEventListener('click', openModal);
    closeBtn.addEventListener('click', closeModal);
    cancelBtn.addEventListener('click', closeModal);

    modal.addEventListener('click', function(e) {
        if (e.target === modal) closeModal();
    });

    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') closeModal();
    });
});
</script>
{% endblock %}
