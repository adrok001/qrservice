{% extends 'dashboard/base.html' %}
{% load dashboard_filters %}

{% block title %}Обзор{% endblock %}
{% block page_title %}Обзор{% endblock %}

{% block content %}
<!-- Фильтры по периоду -->
<div class="period-filters">
    <a href="?period=all{% if spots_param %}&spots={{ spots_param }}{% endif %}" class="period-btn {% if period == 'all' %}active{% endif %}">Всё время</a>
    <a href="?period=week{% if spots_param %}&spots={{ spots_param }}{% endif %}" class="period-btn {% if period == 'week' %}active{% endif %}">Неделя</a>
    <a href="?period=month{% if spots_param %}&spots={{ spots_param }}{% endif %}" class="period-btn {% if period == 'month' %}active{% endif %}">Месяц</a>
    <a href="?period=quarter{% if spots_param %}&spots={{ spots_param }}{% endif %}" class="period-btn {% if period == 'quarter' %}active{% endif %}">Квартал</a>
    <a href="?period=half_year{% if spots_param %}&spots={{ spots_param }}{% endif %}" class="period-btn {% if period == 'half_year' %}active{% endif %}">6 месяцев</a>
    <button type="button" class="period-btn {% if period == 'custom' %}active{% endif %}" id="customPeriodBtn">
        {% if period == 'custom' and date_from and date_to %}
            {{ date_from }} — {{ date_to }}
        {% else %}
            Произвольный
        {% endif %}
    </button>
    {% if available_spots|length > 1 %}
    <div class="spot-dropdown">
        <button type="button" class="period-btn {% if selected_spot_ids %}active{% endif %}" id="spotDropdownBtn">
            {% if not selected_spot_ids %}
                Все филиалы
            {% elif selected_spot_ids|length == 1 %}
                {% for sid, sname in available_spots %}{% if sid in selected_spot_ids %}{{ sname }}{% endif %}{% endfor %}
            {% else %}
                {{ selected_spot_ids|length }} филиал{{ selected_spot_ids|length|pluralize:"а,ов" }}
            {% endif %}
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14" style="margin-left:4px;vertical-align:middle"><polyline points="6 9 12 15 18 9"/></svg>
        </button>
        <div class="spot-dropdown-menu" id="spotDropdownMenu">
            <a href="?period={{ period }}{% if period == 'custom' %}&date_from={{ date_from }}&date_to={{ date_to }}{% endif %}"
               class="spot-dropdown-item {% if not selected_spot_ids %}spot-dropdown-item-active{% endif %}">
                <span class="spot-dropdown-check">{% if not selected_spot_ids %}
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="14" height="14"><polyline points="20 6 9 17 4 12"/></svg>
                {% endif %}</span>
                Все филиалы
            </a>
            {% for spot_id, spot_name in available_spots %}
            <a href="?period={{ period }}{% if period == 'custom' %}&date_from={{ date_from }}&date_to={{ date_to }}{% endif %}&spots={{ spots_param|toggle_spot:spot_id }}"
               class="spot-dropdown-item {% if spot_id in selected_spot_ids %}spot-dropdown-item-active{% endif %}">
                <span class="spot-dropdown-check">{% if spot_id in selected_spot_ids %}
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" width="14" height="14"><polyline points="20 6 9 17 4 12"/></svg>
                {% endif %}</span>
                {{ spot_name }}
            </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>

<!-- Модальное окно выбора периода -->
<div class="modal-overlay" id="periodModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Выберите период</h3>
            <button type="button" class="modal-close" id="closeModal">&times;</button>
        </div>
        <form method="get" class="period-form">
            <input type="hidden" name="period" value="custom">
            {% if spots_param %}<input type="hidden" name="spots" value="{{ spots_param }}">{% endif %}
            <div class="form-row">
                <div class="form-group">
                    <label for="date_from">С</label>
                    <input type="date" id="date_from" name="date_from" value="{{ date_from|default:'' }}" required>
                </div>
                <div class="form-group">
                    <label for="date_to">По</label>
                    <input type="date" id="date_to" name="date_to" value="{{ date_to|default:'' }}" required>
                </div>
            </div>
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" id="cancelModal">Отмена</button>
                <button type="submit" class="btn btn-primary">Применить</button>
            </div>
        </form>
    </div>
</div>

<!-- Верхний ряд: Метрики + Требует внимания -->
<div class="dashboard-top-row">
    <!-- Метрики (слева) -->
    <div class="metrics-simple">
        <div class="metric-simple">
            <div class="metric-simple-value">{{ metrics.rating }}</div>
            <div class="metric-simple-label">Рейтинг</div>
            <div class="metric-sparkline metric-sparkline-{% if metrics.rating_trend == 'up' %}up{% elif metrics.rating_trend == 'down' %}down{% else %}stable{% endif %}">
                <span></span><span></span><span></span><span></span><span></span>
            </div>
            {% if metrics.rating_delta %}
            <div class="metric-delta {% if metrics.rating_delta > 0 %}metric-delta-up{% elif metrics.rating_delta < 0 %}metric-delta-down{% endif %}" title="{{ trend_tooltip }}">
                {% if metrics.rating_delta > 0 %}+{% endif %}{{ metrics.rating_delta }}
            </div>
            {% endif %}
        </div>
        <div class="metric-simple">
            <div class="metric-simple-value">{{ metrics.negative_pct }}%</div>
            <div class="metric-simple-label">Негатив</div>
            <div class="metric-sparkline metric-sparkline-{% if metrics.negative_trend == 'up' %}up-bad{% elif metrics.negative_trend == 'down' %}down-good{% else %}stable{% endif %}">
                <span></span><span></span><span></span><span></span><span></span>
            </div>
            {% if metrics.negative_delta %}
            <div class="metric-delta {% if metrics.negative_delta > 0 %}metric-delta-down{% elif metrics.negative_delta < 0 %}metric-delta-up{% endif %}" title="{{ trend_tooltip }}">
                {% if metrics.negative_delta > 0 %}+{% endif %}{{ metrics.negative_delta }}%
            </div>
            {% endif %}
        </div>
        <div class="metric-simple">
            <div class="metric-simple-value">{{ metrics.total }}</div>
            <div class="metric-simple-label">Отзывов</div>
            <div class="metric-simple-breakdown">
                <a href="{% url 'dashboard:reviews' %}?rating=positive" class="breakdown-positive">{{ metrics.positive_count }}</a>
                <span class="breakdown-separator">/</span>
                <a href="{% url 'dashboard:reviews' %}?rating=negative" class="breakdown-negative">{{ metrics.negative_count }}</a>
            </div>
        </div>
    </div>

    <!-- Требует внимания (справа) -->
    {% if priority_alerts %}
    <div class="attention-section">
        <div class="attention-section-header">
            <span class="attention-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                    <line x1="12" y1="9" x2="12" y2="13"/>
                    <line x1="12" y1="17" x2="12.01" y2="17"/>
                </svg>
            </span>
            <span>Требует внимания</span>
        </div>
        <div class="alert-cards">
            {% for alert in priority_alerts %}
            <a href="{% url 'dashboard:reviews' %}?problem={{ alert.key }}" class="alert-card alert-card-{{ alert.level }}">
                <div class="alert-card-header">
                    <span class="alert-dot alert-dot-{{ alert.level }}"></span>
                    <span class="alert-card-label">{{ alert.label }}</span>
                    <span class="alert-card-count">{{ alert.count }}</span>
                </div>
                <div class="alert-card-spots">
                    {% for spot in alert.spots %}
                    <div class="alert-spot-row">
                        <span class="alert-spot-name">{{ spot.name }}</span>
                        <span class="alert-spot-meta">({{ spot.count }}) {{ spot.last_date|shorttime }}</span>
                    </div>
                    {% endfor %}
                </div>
            </a>
            {% endfor %}
        </div>
    </div>
    {% else %}
    <div class="attention-card attention-ok">
        <div class="attention-header">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                <polyline points="22 4 12 14.01 9 11.01"/>
            </svg>
            <span>Всё в порядке</span>
        </div>
        <div class="attention-ok-text">Критических проблем не обнаружено</div>
    </div>
    {% endif %}
</div>

<!-- Средний ряд: Жалобы + Похвалы -->
<div class="dashboard-middle-row">
    <!-- На что жалуются -->
    <div class="insights-card">
        <div class="insights-header">
            <span class="insights-icon insights-icon-negative">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M16 16s-1.5-2-4-2-4 2-4 2"/>
                    <line x1="9" y1="9" x2="9.01" y2="9"/>
                    <line x1="15" y1="9" x2="15.01" y2="9"/>
                </svg>
            </span>
            <span class="insights-title">На что жалуются</span>
        </div>
        <div class="insights-list">
            {% for item in complaints %}
            <div class="insight-item insight-negative">
                <span class="insight-label">{{ item.label }}</span>
                <span class="insight-count">{{ item.count }}</span>
            </div>
            {% empty %}
            <div class="insights-empty">Жалоб не найдено</div>
            {% endfor %}
        </div>
    </div>

    <!-- Что хвалят -->
    <div class="insights-card">
        <div class="insights-header">
            <span class="insights-icon insights-icon-positive">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M8 14s1.5 2 4 2 4-2 4-2"/>
                    <line x1="9" y1="9" x2="9.01" y2="9"/>
                    <line x1="15" y1="9" x2="15.01" y2="9"/>
                </svg>
            </span>
            <span class="insights-title">Что хвалят</span>
        </div>
        <div class="insights-list">
            {% for item in praises %}
            <div class="insight-item insight-positive">
                <span class="insight-label">{{ item.label }}</span>
                <span class="insight-count">{{ item.count }}</span>
            </div>
            {% empty %}
            <div class="insights-empty">Похвал не найдено</div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Сравнение по точкам (если есть) -->
{% if spots %}
<div class="dashboard-spots-row">
    <div class="spots-card">
        <div class="spots-header">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
                <circle cx="12" cy="10" r="3"/>
            </svg>
            <span>По точкам</span>
        </div>
        <div class="spots-table">
            <div class="spots-table-header">
                <span class="spots-col-name">Точка</span>
                <span class="spots-col-rating">Рейтинг</span>
                <span class="spots-col-negative">Негатив</span>
                <span class="spots-col-trend">Тренд</span>
                <span class="spots-col-issues">Причины</span>
            </div>
            {% for spot in spots %}
            <div class="spots-table-row {% if spot.negative_pct > 20 %}spots-row-warning{% endif %}">
                <span class="spots-col-name">{{ spot.name }}</span>
                <span class="spots-col-rating">
                    <span class="spots-rating-value">{{ spot.rating }}</span>
                    <span class="spots-rating-star">★</span>
                </span>
                <span class="spots-col-negative">{{ spot.negative_pct }}%</span>
                <span class="spots-col-trend">
                    {% if spot.trend == 'up' %}
                    <span class="trend-badge trend-badge-up">↑</span>
                    <span class="trend-delta trend-delta-up">+{{ spot.rating_delta }}</span>
                    {% elif spot.trend == 'down' %}
                    <span class="trend-badge trend-badge-down">↓</span>
                    <span class="trend-delta trend-delta-down">{{ spot.rating_delta }}</span>
                    {% else %}
                    <span class="trend-badge trend-badge-stable">→</span>
                    {% endif %}
                </span>
                <span class="spots-col-issues">
                    {% for issue in spot.top_issues %}{{ issue.label }} ({{ issue.count }}){% if not forloop.last %}, {% endif %}{% endfor %}
                </span>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<!-- График динамики -->
<div class="dashboard-chart-row">
    <div class="chart-card-simple">
        <div class="chart-header-simple">
            <span>Динамика отзывов</span>
        </div>
        <div class="chart-container-simple">
            <canvas id="dailyChart"></canvas>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const dailyData = {{ daily_data_json|safe }};

    // Хелпер для чтения CSS-переменных
    const getCSSVar = (name) => getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    const primaryColor = getCSSVar('--color-primary') || '#000';
    const whiteColor = getCSSVar('--color-white') || '#fff';

    // График по дням
    if (dailyData && dailyData.values && dailyData.values.some(v => v > 0)) {
        const dailyCtx = document.getElementById('dailyChart').getContext('2d');

        new Chart(dailyCtx, {
            type: 'line',
            data: {
                labels: dailyData.labels,
                datasets: [{
                    data: dailyData.values,
                    borderColor: primaryColor,
                    backgroundColor: 'rgba(0, 0, 0, 0.05)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.3,
                    pointRadius: 3,
                    pointBackgroundColor: primaryColor,
                    pointBorderColor: whiteColor,
                    pointBorderWidth: 2,
                    pointHoverRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { stepSize: 1, font: { size: 12 } },
                        grid: { color: 'rgba(0,0,0,0.05)' }
                    },
                    x: {
                        grid: { display: false },
                        ticks: {
                            font: { size: 11 },
                            maxRotation: 0,
                            autoSkip: true,
                            maxTicksLimit: 12
                        }
                    }
                }
            }
        });
    } else {
        document.getElementById('dailyChart').parentElement.innerHTML = '<div class="chart-empty">Нет данных за период</div>';
    }

    // Модальное окно выбора периода
    const modal = document.getElementById('periodModal');
    const openBtn = document.getElementById('customPeriodBtn');
    const closeBtn = document.getElementById('closeModal');
    const cancelBtn = document.getElementById('cancelModal');

    function openModal() { modal.classList.add('active'); }
    function closeModal() { modal.classList.remove('active'); }

    openBtn.addEventListener('click', openModal);
    closeBtn.addEventListener('click', closeModal);
    cancelBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', function(e) { if (e.target === modal) closeModal(); });
    document.addEventListener('keydown', function(e) { if (e.key === 'Escape') closeModal(); });

    // Dropdown выбора филиалов
    const spotBtn = document.getElementById('spotDropdownBtn');
    const spotMenu = document.getElementById('spotDropdownMenu');
    if (spotBtn && spotMenu) {
        spotBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            spotMenu.classList.toggle('open');
        });
        document.addEventListener('click', function(e) {
            if (!spotMenu.contains(e.target) && e.target !== spotBtn) {
                spotMenu.classList.remove('open');
            }
        });
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') spotMenu.classList.remove('open');
        });
    }
});
</script>
{% endblock %}
