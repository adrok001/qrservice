{% extends 'dashboard/base.html' %}

{% block title %}Обзор{% endblock %}
{% block page_title %}Обзор{% endblock %}

{% block content %}
<!-- Фильтры по периоду -->
<div class="period-filters">
    <a href="?period=today" class="period-btn {% if period == 'today' %}active{% endif %}">Сегодня</a>
    <a href="?period=yesterday" class="period-btn {% if period == 'yesterday' %}active{% endif %}">Вчера</a>
    <a href="?period=week" class="period-btn {% if period == 'week' %}active{% endif %}">Неделя</a>
    <a href="?period=month" class="period-btn {% if period == 'month' %}active{% endif %}">Месяц</a>
    <a href="?period=year" class="period-btn {% if period == 'year' %}active{% endif %}">Год</a>
    <a href="?period=all" class="period-btn {% if period == 'all' %}active{% endif %}">Всё время</a>
</div>

<!-- Ключевые метрики -->
<section class="section">
    <h2 class="section-title">Ключевые метрики</h2>
    <div class="metrics-grid">
        <div class="metric-card">
            <div class="metric-label">Средний рейтинг</div>
            <div class="metric-value">{{ analytics.avg_rating }}</div>
            <div class="metric-stars">
                {% for i in "12345" %}
                    <span class="star {% if forloop.counter <= analytics.avg_rating %}active{% endif %}">★</span>
                {% endfor %}
            </div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Всего отзывов</div>
            <div class="metric-value">{{ analytics.total_count }}</div>
        </div>
        <div class="metric-card {% if analytics.sentiment_counts.negative > 0 %}metric-warning{% endif %}">
            <div class="metric-label">Негативных</div>
            <div class="metric-value">{{ analytics.sentiment_counts.negative }}</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Сканирований QR</div>
            <div class="metric-value">{{ stats.total_scans }}</div>
        </div>
    </div>
</section>

<!-- Графики -->
<section class="section">
    <h2 class="section-title">Аналитика</h2>
    <div class="charts-grid">
        <!-- По рейтингу -->
        <div class="chart-card">
            <div class="chart-header">
                <span class="chart-title">По рейтингу</span>
            </div>
            <div class="chart-container">
                <canvas id="ratingChart"></canvas>
            </div>
            <div class="chart-legend" id="ratingLegend"></div>
        </div>

        <!-- По источникам -->
        <div class="chart-card">
            <div class="chart-header">
                <span class="chart-title">По источникам</span>
            </div>
            <div class="chart-container">
                <canvas id="sourceChart"></canvas>
            </div>
            <div class="chart-legend" id="sourceLegend"></div>
        </div>

        <!-- По дням -->
        <div class="chart-card chart-card-wide">
            <div class="chart-header">
                <span class="chart-title">Динамика отзывов</span>
            </div>
            <div class="chart-container chart-container-bar">
                <canvas id="dailyChart"></canvas>
            </div>
        </div>
    </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const analyticsData = {{ analytics_json|safe }};

    // Общие настройки для donut-чартов
    const doughnutOptions = {
        cutout: '65%',
        plugins: {
            legend: { display: false }
        },
        maintainAspectRatio: false
    };

    // График по рейтингу
    if (analyticsData.rating_data.values.some(v => v > 0)) {
        const ratingCtx = document.getElementById('ratingChart').getContext('2d');
        new Chart(ratingCtx, {
            type: 'doughnut',
            data: {
                labels: analyticsData.rating_data.labels,
                datasets: [{
                    data: analyticsData.rating_data.values,
                    backgroundColor: analyticsData.rating_data.colors,
                    borderWidth: 0
                }]
            },
            options: doughnutOptions
        });

        // Легенда для рейтинга
        const ratingLegend = document.getElementById('ratingLegend');
        const total = analyticsData.rating_data.values.reduce((a, b) => a + b, 0);
        analyticsData.rating_data.labels.forEach((label, i) => {
            const value = analyticsData.rating_data.values[i];
            const percent = total > 0 ? Math.round(value / total * 100) : 0;
            if (value > 0) {
                ratingLegend.innerHTML += `
                    <div class="legend-item">
                        <span class="legend-color" style="background: ${analyticsData.rating_data.colors[i]}"></span>
                        <span class="legend-percent">${percent}%</span>
                        <span class="legend-label">${label}</span>
                    </div>
                `;
            }
        });
    } else {
        document.getElementById('ratingChart').parentElement.innerHTML = '<div class="chart-empty">Нет данных</div>';
    }

    // График по источникам
    if (analyticsData.source_data.values.length > 0) {
        const sourceCtx = document.getElementById('sourceChart').getContext('2d');
        new Chart(sourceCtx, {
            type: 'doughnut',
            data: {
                labels: analyticsData.source_data.labels,
                datasets: [{
                    data: analyticsData.source_data.values,
                    backgroundColor: analyticsData.source_data.colors,
                    borderWidth: 0
                }]
            },
            options: doughnutOptions
        });

        // Легенда для источников
        const sourceLegend = document.getElementById('sourceLegend');
        const sourceTotal = analyticsData.source_data.values.reduce((a, b) => a + b, 0);
        analyticsData.source_data.labels.forEach((label, i) => {
            const value = analyticsData.source_data.values[i];
            const percent = sourceTotal > 0 ? Math.round(value / sourceTotal * 100) : 0;
            sourceLegend.innerHTML += `
                <div class="legend-item">
                    <span class="legend-color" style="background: ${analyticsData.source_data.colors[i]}"></span>
                    <span class="legend-percent">${percent}%</span>
                    <span class="legend-label">${label}</span>
                </div>
            `;
        });
    } else {
        document.getElementById('sourceChart').parentElement.innerHTML = '<div class="chart-empty">Нет данных</div>';
    }

    // График по дням
    if (analyticsData.daily_data.values.some(v => v > 0)) {
        const dailyCtx = document.getElementById('dailyChart').getContext('2d');
        new Chart(dailyCtx, {
            type: 'bar',
            data: {
                labels: analyticsData.daily_data.labels,
                datasets: [{
                    data: analyticsData.daily_data.values,
                    backgroundColor: '#000',
                    borderRadius: 4,
                    barThickness: analyticsData.daily_data.labels.length > 14 ? 8 : 20
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { stepSize: 1 },
                        grid: { color: 'rgba(0,0,0,0.05)' }
                    },
                    x: {
                        grid: { display: false }
                    }
                }
            }
        });
    } else {
        document.getElementById('dailyChart').parentElement.innerHTML = '<div class="chart-empty">Нет данных за период</div>';
    }
});
</script>
{% endblock %}
