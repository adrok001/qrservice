{% extends 'base.html' %}

{% block title %}{{ company.name }} — Отзыв{% endblock %}

{% block content %}
<div class="feedback-container" style="background: {{ settings.bg_color }};">
    <header class="feedback-header">
        {% if company.logo %}
            <img src="{{ company.logo.url }}" alt="{{ company.name }}" class="company-logo">
        {% else %}
            <div class="company-logo-placeholder">{{ company.name|slice:":1" }}</div>
        {% endif %}
        <div class="rating-display">
            {% for i in "12345" %}
                <span class="star-small {% if forloop.counter <= rating %}active{% endif %}">★</span>
            {% endfor %}
        </div>
    </header>

    <main class="feedback-main">
        {% if is_positive %}
        <!-- ПОЗИТИВНЫЙ ФЛОУ -->

        {% if platforms %}
        <div class="positive-flow">
            <h2 class="feedback-title">{{ settings.positive_title }}</h2>
            <p class="feedback-subtitle">{{ settings.positive_subtitle }}</p>

            <div class="platforms-list">
                {% for platform in platforms %}
                <a href="{{ platform.url }}" target="_blank" rel="noopener" class="platform-card">
                    <div class="platform-icon">
                        {% if platform.id == 'google' %}
                        <img src="/static/img/platforms/Google.png" alt="Google Maps" class="platform-img">
                        {% elif platform.id == 'yandex' %}
                        <img src="/static/img/platforms/yandex.png" alt="Яндекс Карты" class="platform-img">
                        {% elif platform.id == '2gis' %}
                        <img src="/static/img/platforms/2gis.png" alt="2GIS" class="platform-img">
                        {% else %}
                        <span class="platform-letter">{{ platform.icon }}</span>
                        {% endif %}
                    </div>
                    <div class="platform-info">
                        <span class="platform-name">{{ platform.name }}</span>
                        <span class="platform-action">Оставить отзыв</span>
                    </div>
                    <svg class="platform-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                        <path d="M5 12h14M12 5l7 7-7 7"/>
                    </svg>
                </a>
                {% endfor %}
            </div>

            {% if settings.show_internal_form %}
            <div class="alternative-action">
                <button type="button" class="link-button" onclick="showInternalForm()">
                    Или оставить отзыв напрямую нам
                </button>
            </div>
            {% endif %}
        </div>

        {% if settings.show_internal_form %}
        <!-- Скрытая внутренняя форма -->
        <div class="internal-form-section" id="internal-form" style="display: none;">
            <h2 class="feedback-title">Оставьте отзыв</h2>
            <form id="review-form" class="review-form">
                <input type="hidden" name="company" value="{{ company.id }}">
                <input type="hidden" name="rating" value="{{ rating }}">
                <input type="hidden" name="qr_code" value="{{ qr_code }}">
                {% if spot %}<input type="hidden" name="spot" value="{{ spot.id }}">{% endif %}

                <div class="form-group">
                    <textarea name="text" class="textarea" placeholder="Что понравилось?" rows="3"></textarea>
                </div>

                <div class="form-group">
                    <input type="text" name="author_name" class="input" placeholder="Ваше имя (необязательно)">
                </div>

                <button type="submit" class="btn btn-primary btn-block">Отправить</button>
            </form>

            <button type="button" class="link-button mt-md" onclick="hideInternalForm()">
                Назад к площадкам
            </button>
        </div>
        {% endif %}

        {% else %}
        <!-- Нет подключённых платформ -->
        <h2 class="feedback-title">{{ settings.positive_title }}</h2>
        <p class="feedback-subtitle">Хотите добавить пару слов?</p>

        <form id="review-form" class="review-form">
            <input type="hidden" name="company" value="{{ company.id }}">
            <input type="hidden" name="rating" value="{{ rating }}">
            <input type="hidden" name="qr_code" value="{{ qr_code }}">
            {% if spot %}<input type="hidden" name="spot" value="{{ spot.id }}">{% endif %}

            <div class="form-group">
                <textarea name="text" class="textarea" placeholder="Что понравилось? (необязательно)" rows="3"></textarea>
            </div>

            <div class="form-group">
                <input type="text" name="author_name" class="input" placeholder="Ваше имя (необязательно)">
            </div>

            <button type="submit" class="btn btn-primary btn-block">Отправить</button>
        </form>
        {% endif %}

        {% else %}
        <!-- НЕГАТИВНЫЙ ФЛОУ -->
        <div class="negative-flow">
            <div class="negative-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="48" height="48">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M8 15s1.5-2 4-2 4 2 4 2"/>
                    <line x1="9" y1="9" x2="9.01" y2="9"/>
                    <line x1="15" y1="9" x2="15.01" y2="9"/>
                </svg>
            </div>

            <h2 class="feedback-title">{{ settings.negative_title }}</h2>
            <p class="feedback-subtitle">{{ settings.negative_subtitle }}</p>

            <form id="review-form" class="review-form">
                <input type="hidden" name="company" value="{{ company.id }}">
                <input type="hidden" name="rating" value="{{ rating }}">
                <input type="hidden" name="qr_code" value="{{ qr_code }}">
                {% if spot %}<input type="hidden" name="spot" value="{{ spot.id }}">{% endif %}

                <div class="form-group">
                    <textarea name="text" class="textarea" placeholder="Что случилось?" rows="4" required></textarea>
                </div>

                <div class="form-group">
                    <input type="text" name="author_contact" class="input" placeholder="Телефон или email для связи">
                </div>

                <div class="form-group">
                    <input type="text" name="author_name" class="input" placeholder="Ваше имя">
                </div>

                <button type="submit" class="btn btn-primary btn-block">Отправить</button>
            </form>

            <p class="privacy-note">Ваш отзыв получит руководство напрямую</p>
        </div>
        {% endif %}
    </main>
</div>

<style>
.feedback-container {
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
}

.feedback-header {
    text-align: center;
    margin-bottom: 24px;
}

.company-logo {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    object-fit: cover;
    margin-bottom: 12px;
}

.company-logo-placeholder {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: #000;
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 22px;
    font-weight: 600;
    margin: 0 auto 12px;
}

.rating-display {
    display: flex;
    gap: 4px;
    justify-content: center;
}

.star-small {
    font-size: 18px;
    color: #ddd;
}

.star-small.active {
    color: #fbbf24;
}

.feedback-main {
    width: 100%;
    max-width: 400px;
}

.feedback-title {
    font-size: 22px;
    font-weight: 600;
    margin: 0 0 8px;
    text-align: center;
    color: #000;
}

.feedback-subtitle {
    text-align: center;
    color: #666;
    margin: 0 0 24px;
    font-size: 15px;
    line-height: 1.4;
}

/* Платформы */
.platforms-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 24px;
}

.platform-card {
    display: flex;
    align-items: center;
    gap: 14px;
    padding: 14px 16px;
    background: #fff;
    border: 2px solid #e5e5e5;
    border-radius: 14px;
    text-decoration: none;
    color: inherit;
    transition: all 0.2s;
}

.platform-card:hover {
    border-color: #000;
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0,0,0,0.1);
}

.platform-icon {
    width: 48px;
    height: 48px;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.platform-img {
    width: 40px;
    height: 40px;
    object-fit: cover;
    border-radius: 8px;
}

.platform-letter {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background: #000;
    color: #fff;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    font-weight: 600;
}

.platform-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.platform-name {
    font-weight: 600;
    font-size: 16px;
    color: #000;
}

.platform-action {
    font-size: 13px;
    color: #666;
}

.platform-arrow {
    color: #ccc;
    flex-shrink: 0;
    transition: all 0.2s;
}

.platform-card:hover .platform-arrow {
    color: #000;
    transform: translateX(4px);
}

/* Альтернативное действие */
.alternative-action {
    text-align: center;
    padding-top: 16px;
    border-top: 1px solid #e5e5e5;
}

.link-button {
    background: none;
    border: none;
    color: #666;
    font-size: 14px;
    cursor: pointer;
    text-decoration: underline;
    padding: 8px;
}

.link-button:hover {
    color: #000;
}

/* Негативный флоу */
.negative-flow {
    text-align: center;
}

.negative-icon {
    color: #999;
    margin-bottom: 16px;
}

/* Формы */
.review-form {
    display: flex;
    flex-direction: column;
    gap: 14px;
}

.form-group {
    display: flex;
    flex-direction: column;
}

.input, .textarea {
    width: 100%;
    padding: 14px 16px;
    font-size: 16px;
    border: 2px solid #e5e5e5;
    border-radius: 12px;
    background: #fff;
    transition: border-color 0.15s;
}

.input:focus, .textarea:focus {
    outline: none;
    border-color: #000;
}

.textarea {
    resize: vertical;
    min-height: 100px;
    font-family: inherit;
}

.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    padding: 16px;
    font-size: 16px;
    font-weight: 500;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.15s;
}

.btn-primary {
    background: #000;
    color: #fff;
}

.btn-primary:hover {
    opacity: 0.9;
}

.btn-primary:disabled {
    opacity: 0.5;
    cursor: not-allowed;
}

.btn-block {
    width: 100%;
}

.privacy-note {
    text-align: center;
    font-size: 13px;
    color: #999;
    margin-top: 16px;
}

.mt-md { margin-top: 16px; }
</style>

<script>
function showInternalForm() {
    document.querySelector('.positive-flow').style.display = 'none';
    document.getElementById('internal-form').style.display = 'block';
}

function hideInternalForm() {
    document.querySelector('.positive-flow').style.display = 'block';
    document.getElementById('internal-form').style.display = 'none';
}

document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('review-form');
    if (!form) return;

    form.addEventListener('submit', async function(e) {
        e.preventDefault();

        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Отправка...';

        const formData = new FormData(form);
        const data = {
            company: formData.get('company'),
            rating: parseInt(formData.get('rating')),
            text: formData.get('text') || '',
            author_name: formData.get('author_name') || '',
            author_contact: formData.get('author_contact') || '',
            qr_code: formData.get('qr_code') || '',
            spot: formData.get('spot') || null,
        };

        try {
            const response = await fetch('/f/api/submit/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (response.ok && result.success) {
                window.location.href = '/f/thank-you/?c={{ company.slug }}';
            } else {
                alert(result.error || 'Произошла ошибка');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Отправить';
            }
        } catch (error) {
            alert('Ошибка сети. Попробуйте ещё раз.');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Отправить';
        }
    });
});
</script>
{% endblock %}
