{% extends 'base.html' %}

{% block title %}{{ company.name }} — Отзыв{% endblock %}

{% block content %}
<div class="feedback-container" style="background: {{ settings.bg_color }};">
    <header class="feedback-header">
        {% if company.logo %}
            <img src="{{ company.logo.url }}" alt="{{ company.name }}" class="company-logo small">
        {% else %}
            <div class="company-logo-placeholder small">{{ company.name|slice:":1" }}</div>
        {% endif %}
        <div class="rating-display">
            {% for i in "12345" %}
                <span class="star-small {% if forloop.counter <= rating %}active{% endif %}">★</span>
            {% endfor %}
        </div>
    </header>

    <main class="feedback-main">
        {% if is_positive %}
        <!-- ПОЗИТИВНЫЙ ФЛОУ -->

        {% if platforms %}
        <div class="positive-flow">
            <h2 class="feedback-title">{{ settings.positive_title }}</h2>
            <p class="feedback-subtitle">{{ settings.positive_subtitle }}</p>

            <div class="platforms-list">
                {% for platform in platforms %}
                <a href="{{ platform.url }}" target="_blank" rel="noopener" class="platform-card">
                    <div class="platform-icon">
                        {% if platform.id == 'google' %}
                        <img src="/static/img/platforms/Google.png" alt="Google Maps" class="platform-img">
                        {% elif platform.id == 'yandex' %}
                        <img src="/static/img/platforms/yandex.png" alt="Яндекс Карты" class="platform-img">
                        {% elif platform.id == '2gis' %}
                        <img src="/static/img/platforms/2gis.png" alt="2GIS" class="platform-img">
                        {% else %}
                        <span class="platform-letter">{{ platform.icon }}</span>
                        {% endif %}
                    </div>
                    <div class="platform-info">
                        <span class="platform-name">{{ platform.name }}</span>
                        <span class="platform-action">Оставить отзыв</span>
                    </div>
                    <svg class="platform-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                        <path d="M5 12h14M12 5l7 7-7 7"/>
                    </svg>
                </a>
                {% endfor %}
            </div>

            {% if settings.show_internal_form %}
            <div class="alternative-action">
                <button type="button" class="link-button" onclick="showInternalForm()">
                    Или оставить отзыв напрямую нам
                </button>
            </div>
            {% endif %}
        </div>

        {% if settings.show_internal_form %}
        <!-- Скрытая внутренняя форма -->
        <div class="internal-form-section" id="internal-form" style="display: none;">
            <h2 class="feedback-title">Оставьте отзыв</h2>
            <form id="review-form" class="review-form">
                <input type="hidden" name="company" value="{{ company.id }}">
                <input type="hidden" name="rating" value="{{ rating }}">
                <input type="hidden" name="qr_code" value="{{ qr_code }}">
                {% if spot %}<input type="hidden" name="spot" value="{{ spot.id }}">{% endif %}

                <div class="form-group">
                    <textarea name="text" class="textarea" placeholder="Что понравилось?" rows="3"></textarea>
                </div>

                <div class="form-group">
                    <input type="text" name="author_name" class="input" placeholder="Ваше имя (необязательно)">
                </div>

                <button type="submit" class="btn btn-primary btn-block">Отправить</button>
            </form>

            <button type="button" class="link-button mt-md" onclick="hideInternalForm()">
                Назад к площадкам
            </button>
        </div>
        {% endif %}

        {% else %}
        <!-- Нет подключённых платформ -->
        <h2 class="feedback-title">{{ settings.positive_title }}</h2>
        <p class="feedback-subtitle">Хотите добавить пару слов?</p>

        <form id="review-form" class="review-form">
            <input type="hidden" name="company" value="{{ company.id }}">
            <input type="hidden" name="rating" value="{{ rating }}">
            <input type="hidden" name="qr_code" value="{{ qr_code }}">
            {% if spot %}<input type="hidden" name="spot" value="{{ spot.id }}">{% endif %}

            <div class="form-group">
                <textarea name="text" class="textarea" placeholder="Что понравилось? (необязательно)" rows="3"></textarea>
            </div>

            <div class="form-group">
                <input type="text" name="author_name" class="input" placeholder="Ваше имя (необязательно)">
            </div>

            <button type="submit" class="btn btn-primary btn-block">Отправить</button>
        </form>
        {% endif %}

        {% else %}
        <!-- НЕГАТИВНЫЙ ФЛОУ -->
        <div class="negative-flow">
            <div class="negative-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" width="48" height="48">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M8 15s1.5-2 4-2 4 2 4 2"/>
                    <line x1="9" y1="9" x2="9.01" y2="9"/>
                    <line x1="15" y1="9" x2="15.01" y2="9"/>
                </svg>
            </div>

            <h2 class="feedback-title">{{ settings.negative_title }}</h2>
            <p class="feedback-subtitle">{{ settings.negative_subtitle }}</p>

            <form id="review-form" class="review-form">
                <input type="hidden" name="company" value="{{ company.id }}">
                <input type="hidden" name="rating" value="{{ rating }}">
                <input type="hidden" name="qr_code" value="{{ qr_code }}">
                {% if spot %}<input type="hidden" name="spot" value="{{ spot.id }}">{% endif %}

                <div class="form-group">
                    <textarea name="text" class="textarea" placeholder="Что случилось?" rows="4" required></textarea>
                </div>

                <div class="form-group">
                    <input type="text" name="author_contact" class="input" placeholder="Телефон или email для связи">
                </div>

                <div class="form-group">
                    <input type="text" name="author_name" class="input" placeholder="Ваше имя">
                </div>

                <button type="submit" class="btn btn-primary btn-block">Отправить</button>
            </form>

            <p class="privacy-note">Ваш отзыв получит руководство напрямую</p>
        </div>
        {% endif %}
    </main>
</div>


<script>
function showInternalForm() {
    document.querySelector('.positive-flow').style.display = 'none';
    document.getElementById('internal-form').style.display = 'block';
}

function hideInternalForm() {
    document.querySelector('.positive-flow').style.display = 'block';
    document.getElementById('internal-form').style.display = 'none';
}

document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('review-form');
    if (!form) return;

    form.addEventListener('submit', async function(e) {
        e.preventDefault();

        const submitBtn = form.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Отправка...';

        const formData = new FormData(form);
        const data = {
            company: formData.get('company'),
            rating: parseInt(formData.get('rating')),
            text: formData.get('text') || '',
            author_name: formData.get('author_name') || '',
            author_contact: formData.get('author_contact') || '',
            qr_code: formData.get('qr_code') || '',
            spot: formData.get('spot') || null,
        };

        try {
            const response = await fetch('/f/api/submit/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (response.ok && result.success) {
                window.location.href = '/f/thank-you/?c={{ company.slug }}';
            } else {
                alert(result.error || 'Произошла ошибка');
                submitBtn.disabled = false;
                submitBtn.textContent = 'Отправить';
            }
        } catch (error) {
            alert('Ошибка сети. Попробуйте ещё раз.');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Отправить';
        }
    });
});
</script>
{% endblock %}
