"""
Лемматизатор для анализа тональности отзывов.
Использует pymorphy3 для приведения слов к начальной форме.
"""
import re
from functools import lru_cache
from typing import Set, Tuple

import pymorphy3

# Ленивая инициализация морфологического анализатора
_morph = None


def _get_morph():
    """Ленивая загрузка морфологического анализатора."""
    global _morph
    if _morph is None:
        _morph = pymorphy3.MorphAnalyzer()
    return _morph


@lru_cache(maxsize=10000)
def get_lemma(word: str) -> str:
    """Получить лемму (начальную форму) слова с кэшированием."""
    morph = _get_morph()
    parsed = morph.parse(word)
    if parsed:
        return parsed[0].normal_form
    return word


def lemmatize_text(text: str) -> list[str]:
    """Лемматизировать текст, вернуть список лемм."""
    words = re.findall(r'[а-яёА-ЯЁ]+', text.lower())
    return [get_lemma(word) for word in words]


# ============================================================================
# СЛОВАРИ ЛЕММ
# ============================================================================

# Негативные леммы (только базовые формы)
NEGATIVE_LEMMAS: Set[str] = {
    # Общий негатив
    "ужасный", "ужас", "кошмар", "кошмарный",
    "отвратительный", "плохой", "худший",

    # Еда
    "невкусный", "несъедобный", "холодный", "пересоленный",
    "недосоленный", "сырой", "подгореть", "подгорелый",
    "испортить", "испорченный", "несвежий", "тухлый", "протухнуть",
    "тухлятина", "тухнуть",  # "со вкусом тухлятины"
    "кислый", "пресный", "безвкусный",

    # Сервис/персонал
    "грубый", "грубость", "хам", "хамить", "хамство", "нахамить",
    "лгун", "обманщик", "обмануть", "обман",
    "невежливый", "игнорировать", "наглый", "наглость",
    "ленивый", "лень", "медлительный", "ленивец",
    "тюлень",  # "как тюлени" = медленные/ленивые
    "непрофессиональный", "непрофессионализм",
    "некомпетентный", "некомпетентность",

    # Обсчёт/цена
    "обсчитать", "переплатить", "дорогой", "завышенный",
    "пробить",  # "пробили больше"

    # Ожидание
    "долгий", "медленный", "медленно", "долго",

    # Комфорт
    "грязный", "грязь", "вонь", "вонять", "вонючий",
    "шумный", "душный", "тесный",
    "капать", "течь", "протекать",  # "капает с кондиционера"

    # Здоровье/безопасность
    "тошнить", "тошнота", "рвота", "отравить", "отравление",
    "диарея", "понос", "больница",

    # Эмоции/общее
    "разочаровать", "разочарование", "расстроить",
    "неприятный", "неприятно", "испортить",
    "ненавидеть", "бесить", "раздражать",

    # Процесс/бронирование
    "занятый", "занять",  # "столик был занят"
}

# Негативные фразы (проверяются отдельно)
NEGATIVE_PHRASES: Set[str] = {
    # Рекомендации
    "не рекомендую",
    "не советую",
    "не приду",
    "не вернусь",
    "ни ногой", "не ногой",  # вариант с опечаткой
    "больше не приду",

    # Оценка
    "так себе",
    "на троечку",
    "бывало лучше",
    "не очень",
    "не особо",
    "могло быть лучше",

    # Время ожидания (негатив)
    "час ждал", "час ждали", "час ожидания",
    "полчаса ждал", "полчаса ждали",
    "40 минут", "45 минут", "50 минут",
    "ждали очень долго", "очень долго ждали",
    "ждать целый час", "ждали целый час",

    # Бронирование/процесс
    "было занято", "оказалось занято", "оказался занят",
    "столик занят", "место занято",

    # Обсчёт
    "пробили больше", "посчитали больше",
    "в счёте больше", "в счете больше",
    "лишнее в счёте", "лишнее в счете",
}

# Позитивные леммы
POSITIVE_LEMMAS: Set[str] = {
    # Сильный позитив
    "шикарный", "великолепный", "превосходный", "потрясающий",
    "восхитительный", "изумительный", "божественный", "идеальный",
    "прекрасный", "замечательный", "чудесный", "волшебный",

    # Обычный позитив
    "отличный", "хороший", "классный", "супер",
    "вкусный", "свежий", "качественный",
    "быстрый", "быстро", "оперативный", "оперативно",
    "вежливый", "приятный", "внимательный", "добрый", "милый",
    "уютный", "комфортный", "чистый", "красивый", "стильный",
    "душевный", "тёплый", "симпатичный", "отменный",

    # Сленг/разговорное
    "кайф", "кайфовый", "огонь", "бомба", "топ", "круто", "крутой",
    "офигенный", "клёвый", "клевый", "зачёт", "зачет",
    "чёткий", "четкий", "лайк", "красавчик",

    # Благодарность/похвала
    "спасибо", "молодец", "прекрасно",

    # Глаголы
    "понравиться", "нравиться", "рекомендовать", "советовать",
    "порадовать", "восхитить", "удивить",

    # Существительные
    "восторг", "удовольствие", "наслаждение",
}

# Позитивные фразы
POSITIVE_PHRASES: Set[str] = {
    "выше всяких похвал",
    "вне конкуренции",
    "на высоте",
    "на высшем уровне",
    "в восторге",
    "пальчики оближешь",
    "5 из 5",
    "пять звёзд",
    "пять звезд",
    "просто кайф",
    "просто огонь",
    "просто бомба",
    # Цена
    "низкие цены", "низких цен", "самых низких",
    "дёшево и вкусно", "дешево и вкусно",
    # Чистота (отрицание негатива = позитив)
    "ни одной грязной", "не было грязных",
    # Рекомендации
    "буду советовать", "всем советовать",
    "обязательно придём", "обязательно приду",
}

# Слова, которые при отрицании дают негатив
# "не извинились" = негатив, "не помогли" = негатив, "не дали" = негатив
NEGATABLE_WORDS: Set[str] = {
    # Извинения/вежливость
    "извиниться", "извинение", "извинить",

    # Помощь/внимание
    "помочь", "помощь", "внимание", "обратить",
    "встретить", "проводить", "обслужить", "обслуживать",

    # Действия персонала
    "предложить", "принести", "дать", "давать",
    "убрать", "почистить", "поменять", "заменить",
    "подойти", "подходить", "позвать", "откликнуться",
    "ответить", "отвечать", "реагировать",

    # Качество еды/сервиса
    "понравиться", "нравиться", "устроить", "устраивать",
    "оправдать", "соответствовать",

    # Время
    "успеть", "дождаться",
}

# Негативные конструкции с предлогом "без"
# "без внимания", "без извинений" = негатив
NEGATIVE_WITHOUT_CONSTRUCTS: Set[str] = {
    "внимание", "извинение", "ответ", "реакция",
    "помощь", "обслуживание", "сервис",
    "вкус", "соль", "специя",
}


# Regex паттерны для негативного времени ожидания
# "1 час", "30 минут", "полтора часа" в контексте ожидания = негатив
WAIT_TIME_PATTERNS = [
    # N час/часа/часов (30+ минут или любые часы = долго)
    r'(\d+)\s*(час|часа|часов)',
    # 30+ минут
    r'(3\d|4\d|5\d|\d{3,})\s*(минут|мин)',
    # полчаса, полтора часа
    r'(полчаса|полтора\s*часа)',
]


def has_negative_sentiment(text: str) -> Tuple[bool, list[str]]:
    """
    Проверить наличие негативной тональности в тексте.

    Обрабатывает:
    - Негативные леммы (ужасный, грубый)
    - Негативные фразы (не рекомендую, так себе)
    - Отрицания позитивных слов (не вкусно, не понравилось)
    - Конструкции с "без" (без внимания, без ответа)
    - Долгое время ожидания (1 час, 30+ минут)

    Returns:
        (has_negative, found_markers) - флаг и список найденных маркеров
    """
    text_lower = text.lower()
    found = []

    # Проверяем фразы
    for phrase in NEGATIVE_PHRASES:
        if phrase in text_lower:
            found.append(phrase)

    # Проверяем леммы
    lemmas = lemmatize_text(text)
    for lemma in lemmas:
        if lemma in NEGATIVE_LEMMAS:
            found.append(lemma)

    # Проверяем отрицания: "не" + глагол/прилагательное
    words = re.findall(r'[а-яёА-ЯЁ]+', text_lower)
    for i, word in enumerate(words):
        if i > 0 and words[i-1] in ('не', 'нет', 'ни'):
            lemma = get_lemma(word)
            # Отрицание позитивного = негатив
            if lemma in POSITIVE_LEMMAS:
                found.append(f'не {word}')
            # Отрицание negatable = негатив
            if lemma in NEGATABLE_WORDS:
                found.append(f'не {word}')

    # Проверяем конструкции с "без"
    for i, word in enumerate(words):
        if words[i] == 'без' and i + 1 < len(words):
            next_lemma = get_lemma(words[i + 1])
            if next_lemma in NEGATIVE_WITHOUT_CONSTRUCTS:
                found.append(f'без {words[i + 1]}')

    # Проверяем долгое время ожидания
    for pattern in WAIT_TIME_PATTERNS:
        match = re.search(pattern, text_lower)
        if match:
            found.append(f'долгое ожидание: {match.group(0)}')

    return (len(found) > 0, found)


def has_positive_sentiment(text: str) -> Tuple[bool, list[str]]:
    """
    Проверить наличие позитивной тональности в тексте.

    Returns:
        (has_positive, found_markers) - флаг и список найденных маркеров
    """
    text_lower = text.lower()
    found = []

    # Проверяем фразы
    for phrase in POSITIVE_PHRASES:
        if phrase in text_lower:
            found.append(phrase)

    # Проверяем леммы
    lemmas = lemmatize_text(text)
    for lemma in lemmas:
        if lemma in POSITIVE_LEMMAS:
            found.append(lemma)

    return (len(found) > 0, found)


def detect_sentiment(text: str, rating: int = 3) -> Tuple[str, list[str], list[str]]:
    """
    Определить тональность текста с учётом рейтинга как tiebreaker.

    Returns:
        (sentiment, negative_markers, positive_markers)
    """
    has_neg, neg_markers = has_negative_sentiment(text)
    has_pos, pos_markers = has_positive_sentiment(text)

    if has_neg and not has_pos:
        return ('negative', neg_markers, pos_markers)
    elif has_pos and not has_neg:
        return ('positive', neg_markers, pos_markers)
    elif has_neg and has_pos:
        # Смешанный — используем рейтинг
        if rating <= 2:
            return ('negative', neg_markers, pos_markers)
        elif rating >= 4:
            return ('positive', neg_markers, pos_markers)
        return ('neutral', neg_markers, pos_markers)

    # Ничего не найдено — по рейтингу
    if rating <= 2:
        return ('negative', neg_markers, pos_markers)
    elif rating >= 4:
        return ('positive', neg_markers, pos_markers)
    return ('neutral', neg_markers, pos_markers)
