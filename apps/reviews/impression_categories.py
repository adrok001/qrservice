"""
Карта впечатлений (Impression Map) для ниши HoReCa
==================================================

HoReCa (Hotel/Restaurant/Cafe) — сегмент индустрии гостеприимства.

Категории описывают основные аспекты клиентского опыта,
упоминаемые в отзывах. Используются для аналитики и
автоматической классификации обратной связи.

Тональность (sentiment):
- positive — позитивное упоминание
- negative — негативное упоминание
- neutral  — нейтральное упоминание

Правила разметки:
1. Если в тексте нет явных упоминаний конкретных аспектов —
   ставить только "Общее/Общее впечатление"
2. "Комфорт/Интерьер/атмосфера" — только при наличии маркеров:
   уютно, атмосферно, интерьер, музыка, шумно, красиво, чисто
3. Не "размазывать" общие фразы по всем категориям —
   это искажает аналитику
"""

# Основные категории и их подкатегории
# ВАЖНО: "Безопасность" — критическая категория, выводить ПЕРВОЙ, красным цветом
IMPRESSION_CATEGORIES = {
    "Безопасность": ["Отравление/симптомы"],
    "Сервис": [
        "Сервис/персонал",
        "Вежливость/уважение",
        "Хамство/грубость/конфликт",
        "Внимание/вовлечённость",
        "Компетентность/знание меню",
        "Решение проблем/гарантия",
        "Коммуникация/тон",
        "Навязывание/апселл",
    ],
    "Скорость": ["Скорость/ожидание", "Скорость обслуживания"],
    "Продукт": ["Еда/кухня", "Напитки/бар", "Качество/свежесть", "Порции/сытость"],
    "Цена": ["Цена/ценность"],
    "Комфорт": ["Интерьер/атмосфера", "Чистота/санитария"],
    "Процесс": [
        "Бронирование/стол",
        "Управление/организация зала",
        "Заказ/ошибки",
        "Оплата/касса",
        "Доставка/вынос",
        "Локация/парковка",
    ],
    "Общее": ["Общее впечатление"],
}

# Допустимые значения тональности
SENTIMENT_CHOICES = [
    ("positive", "Позитивная"),
    ("negative", "Негативная"),
    ("neutral", "Нейтральная"),
]

# Маркеры категорий (ключевые слова для определения аспекта)
# CATEGORY_LEMMAS используется в segment_analyzer (set для быстрого поиска)
CATEGORY_LEMMAS = {
    "Безопасность": {
        "отравление", "отравить", "тошнота", "тошнить", "рвота", "рвать",
        "температура", "больница", "скорая", "диарея", "понос",
    },
    "Сервис": {
        "сервис", "официант", "персонал", "обслуживание", "сотрудник", "менеджер",
        "администратор", "хостес", "бармен", "повар", "девушка", "парень",
    },
    "Скорость": {
        "ждать", "ожидание", "долго", "быстро", "быстрый", "оперативный",
        "медленно", "медленный",
    },
    "Продукт": {
        "еда", "блюдо", "кухня", "готовить", "вкус", "вкусный", "невкусный",
        "обед", "завтрак", "ужин", "порция", "меню", "свежий", "горячий", "холодный",
        "салат", "суп", "борщ", "пицца", "паста", "стейк", "шашлык", "бургер",
        "суши", "ролл", "десерт", "торт", "кофе", "чай", "напиток", "вино", "пиво",
    },
    "Цена": {
        "цена", "дорого", "дорогой", "дёшево", "дешёвый", "стоимость",
        "чек", "счёт", "бюджет", "переплатить", "недорого",
    },
    "Комфорт": {
        "атмосфера", "уютный", "уют", "интерьер", "дизайн", "декор", "обстановка",
        "музыка", "шумный", "громкий", "тихий", "красивый", "стильный",
        "чистый", "чистота", "грязный", "грязь", "туалет",
    },
    "Процесс": {
        "бронирование", "бронь", "столик", "резерв",
        "ошибка", "перепутать", "забыть",
        "оплата", "касса", "терминал", "карта", "наличные",
        "доставка", "самовывоз", "курьер", "парковка",
    },
    "Общее": {
        "место", "заведение", "ресторан", "кафе", "бар",
    },
}

CATEGORY_MARKERS = {
    "Безопасность": [
        "отравлен", "отравил", "тошнот", "рвот", "температур",
        "больниц", "скорая", "плохо стало", "стало плохо",
    ],
    "Сервис": [
        "сервис", "официант", "персонал", "обслуживан", "сотрудник", "менеджер",
        "администратор", "хостес", "бармен", "повар",
    ],
    "Скорость": [
        "ждал", "ждём", "ожидан", "долго", "быстр", "оперативн",
        "минут ждал", "час ждал", "медленн",
    ],
    "Продукт": [
        # Общие термины
        "еда", "едой", "еды", "едою", "блюд", "кухн", "кухни", "готовят", "готовил",
        "вкус", "невкус", "обед", "завтрак", "ужин", "ланч", "бранч",
        "порци", "меню", "свеж", "горяч", "холодн",
        # Салаты
        "салат", "цезар", "греческ", "оливье", "капрезе", "винегрет",
        # Супы
        "суп", "борщ", "щи", "солянк", "окрошк", "харчо", "том-ям", "фо", "рамен",
        # Пицца/паста/итальянская
        "пицц", "паст", "карбонар", "болоньез", "маргарит", "лазань", "ризотто",
        # Мясо/птица
        "стейк", "шашлык", "рёбрышк", "ребрышк", "крыл", "наггетс", "отбивн",
        "котлет", "бифштекс", "медальон", "филе", "гриль",
        # Азиатская кухня
        "суши", "ролл", "сашими", "вок", "пад-тай", "лапш", "дим-сам",
        # Кавказская/грузинская
        "хинкал", "хачапур", "шаурм", "долм", "плов", "манты", "самс",
        # Фастфуд
        "бургер", "гамбургер", "хот-дог", "сэндвич", "картошк фри", "фри",
        # Выпечка/десерты
        "десерт", "торт", "пирог", "пирож", "чизкейк", "тирамису", "брауни",
        "штрудел", "панакот", "эклер", "круассан", "блин", "сырник",
        # Напитки
        "кофе", "латте", "капучин", "эспрессо", "американо", "раф",
        "чай", "напиток", "коктейл", "смузи", "фреш", "морс", "лимонад",
        "вино", "пиво", "виски", "водк",
    ],
    "Цена": [
        "цен", "дорог", "дёшев", "дешев", "стоимост", "чек", "счёт", "счет",
        "бюджет", "переплат", "недорог",
    ],
    "Комфорт": [
        "атмосфер", "уютн", "интерьер", "дизайн", "декор", "обстановк",
        "музык", "шумн", "громк", "тих", "красив", "стильн",
        "чист", "грязн", "убран", "туалет", "санитар",
        "место", "местечко", "заведени",
    ],
    "Процесс": [
        "бронирован", "бронь", "столик заказ", "резерв",
        "организац", "управлен", "зал ",
        "заказ ошиб", "ошиб", "перепутал", "забыл принес",
        "оплат", "касс", "терминал", "карт", "наличн",
        "доставк", "вынос", "самовывоз", "курьер",
        "локац", "парков", "найти", "добрат",
    ],
}

# Маркеры начала позитивного сегмента
POSITIVE_SEGMENT_MARKERS = [
    r"из плюсов", r"из достоинств", r"плюс\w*\s*[:\-—]", r"плюс\w*\s+в том",
    r"что понравилось", r"понравилось\s*[:\-—]", r"хорошо\s*[:\-—]",
    r"достоинств\w*\s*[:\-—]", r"положительн\w*\s*[:\-—]", r"порадовал\w*",
    r"зато\b", r"но\s+понравил", r"но\s+порадовал",
]

# Маркеры начала негативного сегмента
NEGATIVE_SEGMENT_MARKERS = [
    r"из минусов", r"из недостатков", r"минус\w*\s*[:\-—]", r"минус\w*\s+в том",
    r"что не понравилось", r"не понравилось\s*[:\-—]", r"плохо\s*[:\-—]",
    r"недостатк\w*\s*[:\-—]", r"отрицательн\w*\s*[:\-—]", r"разочаровал\w*",
    r"огорчил\w*", r"к сожалению", r"жаль\s*(,|что)",
    r"но\s+не понравил", r"но\s+разочаровал",
    r"во-первых", r"во-вторых", r"в-третьих",
]

# Плоский список всех подкатегорий для валидации
ALL_SUBCATEGORIES = [
    {"category": cat, "subcategory": sub}
    for cat, subs in IMPRESSION_CATEGORIES.items()
    for sub in subs
]


def get_category_by_subcategory(subcategory: str) -> str | None:
    """Получить основную категорию по подкатегории."""
    for category, subcategories in IMPRESSION_CATEGORIES.items():
        if subcategory in subcategories:
            return category
    return None


def validate_impression_tag(tag: dict) -> bool:
    """Валидация тега впечатления."""
    required_keys = {"category", "subcategory", "sentiment"}
    if not all(key in tag for key in required_keys):
        return False
    if tag["category"] not in IMPRESSION_CATEGORIES:
        return False
    if tag["subcategory"] not in IMPRESSION_CATEGORIES[tag["category"]]:
        return False
    valid_sentiments = [s[0] for s in SENTIMENT_CHOICES]
    return tag["sentiment"] in valid_sentiments
