"""
Карта впечатлений (Impression Map) для ниши HoReCa
==================================================

HoReCa (Hotel/Restaurant/Cafe) — сегмент индустрии гостеприимства.

Категории описывают основные аспекты клиентского опыта,
упоминаемые в отзывах. Используются для аналитики и
автоматической классификации обратной связи.

Тональность (sentiment):
- positive — позитивное упоминание
- negative — негативное упоминание
- neutral  — нейтральное упоминание

Правила разметки:
1. Если в тексте нет явных упоминаний конкретных аспектов —
   ставить только "Общее/Общее впечатление"
2. "Комфорт/Интерьер/атмосфера" — только при наличии маркеров:
   уютно, атмосферно, интерьер, музыка, шумно, красиво, чисто
3. Не "размазывать" общие фразы по всем категориям —
   это искажает аналитику

Маркеры для категорий:
- БЕЗОПАСНОСТЬ (КРИТИЧЕСКАЯ!): отравление, отравился, тошнота, рвота,
  температура, больница, скорая, плохо стало
- Сервис: официант, персонал, обслуживание, вежливый, грубый
- Скорость: ждали, быстро, долго, оперативно
- Продукт: еда, блюдо, кухня, кофе, напиток, вкусно, невкусно, свежий, порция
- Цена: цена, дорого, дёшево, стоимость, чек
- Комфорт: уютно, атмосфера, интерьер, музыка, шумно, чисто, грязно
- Процесс: бронь, столик, заказ, ошибка, оплата, касса, доставка, парковка
- Общее: всё понравилось, всё идеально, супер, ужас, кошмар, нормально
"""

# Основные категории и их подкатегории
# ВАЖНО: "Безопасность" — критическая категория, выводить ПЕРВОЙ, красным цветом
IMPRESSION_CATEGORIES = {
    "Безопасность": [
        "Отравление/симптомы",
    ],
    "Сервис": [
        "Сервис/персонал",
        "Вежливость/уважение",
        "Хамство/грубость/конфликт",
        "Внимание/вовлечённость",
        "Компетентность/знание меню",
        "Решение проблем/гарантия",
        "Коммуникация/тон",
        "Навязывание/апселл",
    ],
    "Скорость": [
        "Скорость/ожидание",
        "Скорость обслуживания",
    ],
    "Продукт": [
        "Еда/кухня",
        "Напитки/бар",
        "Качество/свежесть",
        "Порции/сытость",
    ],
    "Цена": [
        "Цена/ценность",
    ],
    "Комфорт": [
        "Интерьер/атмосфера",
        "Чистота/санитария",
    ],
    "Процесс": [
        "Бронирование/стол",
        "Управление/организация зала",
        "Заказ/ошибки",
        "Оплата/касса",
        "Доставка/вынос",
        "Локация/парковка",
    ],
    "Общее": [
        "Общее впечатление",
    ],
}

# Допустимые значения тональности
SENTIMENT_CHOICES = [
    ("positive", "Позитивная"),
    ("negative", "Негативная"),
    ("neutral", "Нейтральная"),
]

# Плоский список всех подкатегорий для валидации
ALL_SUBCATEGORIES = []
for category, subcategories in IMPRESSION_CATEGORIES.items():
    for subcategory in subcategories:
        ALL_SUBCATEGORIES.append({
            "category": category,
            "subcategory": subcategory,
        })


def get_category_by_subcategory(subcategory: str) -> str | None:
    """Получить основную категорию по подкатегории."""
    for category, subcategories in IMPRESSION_CATEGORIES.items():
        if subcategory in subcategories:
            return category
    return None


def validate_impression_tag(tag: dict) -> bool:
    """
    Валидация тега впечатления.

    Ожидаемый формат:
    {
        "category": "Сервис",
        "subcategory": "Вежливость/уважение",
        "sentiment": "positive"
    }
    """
    required_keys = {"category", "subcategory", "sentiment"}
    if not all(key in tag for key in required_keys):
        return False

    if tag["category"] not in IMPRESSION_CATEGORIES:
        return False

    if tag["subcategory"] not in IMPRESSION_CATEGORIES[tag["category"]]:
        return False

    valid_sentiments = [s[0] for s in SENTIMENT_CHOICES]
    if tag["sentiment"] not in valid_sentiments:
        return False

    return True
