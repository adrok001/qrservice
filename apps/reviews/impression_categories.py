"""
Карта впечатлений (Impression Map) для ниши HoReCa
==================================================

HoReCa (Hotel/Restaurant/Cafe) — сегмент индустрии гостеприимства.

Категории описывают основные аспекты клиентского опыта,
упоминаемые в отзывах. Используются для аналитики и
автоматической классификации обратной связи.

Тональность (sentiment):
- positive — позитивное упоминание
- negative — негативное упоминание
- neutral  — нейтральное упоминание

Правила разметки:
1. Если в тексте нет явных упоминаний конкретных аспектов —
   ставить только "Общее/Общее впечатление"
2. "Комфорт/Интерьер/атмосфера" — только при наличии маркеров:
   уютно, атмосферно, интерьер, музыка, шумно, красиво, чисто
3. Не "размазывать" общие фразы по всем категориям —
   это искажает аналитику

Маркеры для категорий:
- БЕЗОПАСНОСТЬ (КРИТИЧЕСКАЯ!): отравление, отравился, тошнота, рвота,
  температура, больница, скорая, плохо стало
- Сервис: официант, персонал, обслуживание, вежливый, грубый
- Скорость: ждали, быстро, долго, оперативно
- Продукт: еда, блюдо, кухня, кофе, напиток, вкусно, невкусно, свежий, порция
- Цена: цена, дорого, дёшево, стоимость, чек
- Комфорт: уютно, атмосфера, интерьер, музыка, шумно, чисто, грязно
- Процесс: бронь, столик, заказ, ошибка, оплата, касса, доставка, парковка
- Общее: всё понравилось, всё идеально, супер, ужас, кошмар, нормально
"""

# Основные категории и их подкатегории
# ВАЖНО: "Безопасность" — критическая категория, выводить ПЕРВОЙ, красным цветом
IMPRESSION_CATEGORIES = {
    "Безопасность": [
        "Отравление/симптомы",
    ],
    "Сервис": [
        "Сервис/персонал",
        "Вежливость/уважение",
        "Хамство/грубость/конфликт",
        "Внимание/вовлечённость",
        "Компетентность/знание меню",
        "Решение проблем/гарантия",
        "Коммуникация/тон",
        "Навязывание/апселл",
    ],
    "Скорость": [
        "Скорость/ожидание",
        "Скорость обслуживания",
    ],
    "Продукт": [
        "Еда/кухня",
        "Напитки/бар",
        "Качество/свежесть",
        "Порции/сытость",
    ],
    "Цена": [
        "Цена/ценность",
    ],
    "Комфорт": [
        "Интерьер/атмосфера",
        "Чистота/санитария",
    ],
    "Процесс": [
        "Бронирование/стол",
        "Управление/организация зала",
        "Заказ/ошибки",
        "Оплата/касса",
        "Доставка/вынос",
        "Локация/парковка",
    ],
    "Общее": [
        "Общее впечатление",
    ],
}

# Допустимые значения тональности
SENTIMENT_CHOICES = [
    ("positive", "Позитивная"),
    ("negative", "Негативная"),
    ("neutral", "Нейтральная"),
]

# =============================================================================
# МАРКЕРЫ ДЛЯ АВТОМАТИЧЕСКОЙ ДЕТЕКЦИИ КАТЕГОРИЙ
# =============================================================================

# Маркеры категорий (ключевые слова для определения аспекта)
CATEGORY_MARKERS = {
    "Безопасность": [
        "отравлен", "отравил", "тошнот", "рвот", "температур",
        "больниц", "скорая", "плохо стало", "стало плохо",
    ],
    "Сервис": [
        "официант", "персонал", "обслуживан", "сотрудник", "менеджер",
        "администратор", "хостес", "бармен", "повар",
    ],
    "Скорость": [
        "ждал", "ждём", "ожидан", "долго", "быстр", "оперативн",
        "минут ждал", "час ждал", "медленн",
    ],
    "Продукт": [
        "еда", "едой", "блюд", "кухн", "кухни", "готовят", "готовил",
        "вкус", "невкус", "обед", "завтрак", "ужин", "ланч", "бранч",
        "порци", "меню", "салат", "суп", "пицц", "паст", "стейк",
        "десерт", "кофе", "чай", "напиток", "коктейл", "вино", "пиво",
        "свеж", "горяч", "холодн",
    ],
    "Цена": [
        "цен", "дорог", "дёшев", "дешев", "стоимост", "чек", "счёт", "счет",
        "бюджет", "переплат", "недорог",
    ],
    "Комфорт": [
        "атмосфер", "уютн", "интерьер", "дизайн", "декор", "обстановк",
        "музык", "шумн", "громк", "тих", "красив", "стильн",
        "чист", "грязн", "убран", "туалет", "санитар",
        "место", "местечко", "заведени",
    ],
    "Процесс": [
        "бронирован", "бронь", "столик заказ", "резерв",
        "организац", "управлен", "зал ",
        "заказ ошиб", "ошиб", "перепутал", "забыл принес",
        "оплат", "касс", "терминал", "карт", "наличн",
        "доставк", "вынос", "самовывоз", "курьер",
        "локац", "парков", "найти", "добрат",
    ],
}

# Усилители позитива: комплимент-идиомы (сильный позитив)
POSITIVE_BOOSTERS_IDIOMS = [
    r"выше всяких похвал",
    r"вне конкуренции",
    r"на высоте",
    r"на высшем уровне",
    r"всё на высшем уровне",
    r"в восторге",
    r"восторг",
    r"пальчики оближешь",
    r"пальчики оближ",
    r"бомба",  # в контексте еды
    r"огонь",  # в контексте еды
    r"лучше\w*\s+мест",
    r"лучший",
    r"лучшее",
    r"любим\w+\s+мест",
    r"любимое",
]

# Усилители позитива: слова-комплименты
POSITIVE_BOOSTERS_WORDS = [
    r"шикарн\w*",
    r"великолепн\w*",
    r"превосходн\w*",
    r"потрясающ\w*",
    r"восхитительн\w*",
    r"изумительн\w*",
    r"божественн\w*",
    r"идеальн\w*",
    r"прекрасн\w*",
    r"отличн\w*",
    r"замечательн\w*",
    r"чудесн\w*",
    r"супер",
    r"класс",
    r"классн\w*",
    r"топ",
    r"рекомендую",
    r"хорош\w*",
    r"симпатичн\w*",
    r"отменн\w*",
    r"вежлив\w*",
    r"приятн\w*",
    r"понравил\w*",
    r"нравится",
    r"уютн\w*",
    r"вкусн\w*",
    r"душевн\w*",
    r"добр\w*",
    r"милы\w*",
    r"внимательн\w*",
    r"быстр\w*",
    r"свеж\w*",
    r"качествен\w*",
]

# Усилители позитива: оценки-шкалы
POSITIVE_BOOSTERS_SCALE = [
    r"на\s*5\s*\+",
    r"на\s*пять\s*\+",
    r"на\s*пятёрку",
    r"на\s*пятерку",
    r"5\s*(из|/)\s*5",
    r"пять\s*(из|/)\s*пяти",
    r"5\s*зв[её]зд",
    r"пять\s*зв[её]зд",
    r"пять\s*с\s*плюсом",
    r"10\s*(из|/)\s*10",
    r"десять\s*(из|/)\s*десяти",
    r"100\s*%",
    r"сто\s*процентов",
]

# Негативные маркеры (определяют негативную тональность)
NEGATIVE_MARKERS = [
    r"ужас\w*",
    r"кошмар\w*",
    r"отвратительн\w*",
    r"худш\w*",
    r"плох\w*",
    r"ужасн\w*",
    r"невкусн\w*",
    r"несъедобн\w*",
    r"холодн\w+\s+(еда|блюд|пицц|суп)",
    r"пересолен\w*",
    r"недосолен\w*",
    r"сырой",
    r"подгорел\w*",
    r"испорчен\w*",
    r"несвеж\w*",
    r"грубо",
    r"груб\w+",
    r"хам\w*",
    r"невежлив\w*",
    r"игнорир\w*",
    r"наглы\w*",
    r"не рекомендую",
    r"не советую",
    r"не приду",
    r"не вернусь",
    r"ни ногой",
    r"разочарован\w*",
    r"обман\w*",
    r"так себе",
    r"на троечку",
    r"бывало лучше",
    r"бывало хуже",
    r"не очень",
    r"не особо",
    r"могло быть лучше",
]

# Нейтральные маркеры (ни позитив, ни негатив)
NEUTRAL_MARKERS = [
    r"нормальн\w*",
    r"обычн\w*",
    r"средн\w*",
    r"стандартн\w*",
    r"ничего особ\w*",
    r"сойдёт",
    r"сойдет",
]

# Маркеры конфликта (сигнал о смешанной оценке)
CONFLICT_MARKERS = [
    r"\bно\b",
    r"\bоднако\b",
    r"\bхотя\b",
    r"\bзато\b",
    r"\bправда\b",
    r"\bвпрочем\b",
    r"\bс другой стороны\b",
    r"\bк сожалению\b",
    r"\bжаль\b",
    r"\bминус\w*\b",
]

# =============================================================================
# ВСПОМОГАТЕЛЬНЫЕ СТРУКТУРЫ
# =============================================================================

# Плоский список всех подкатегорий для валидации
ALL_SUBCATEGORIES = []
for category, subcategories in IMPRESSION_CATEGORIES.items():
    for subcategory in subcategories:
        ALL_SUBCATEGORIES.append({
            "category": category,
            "subcategory": subcategory,
        })


def get_category_by_subcategory(subcategory: str) -> str | None:
    """Получить основную категорию по подкатегории."""
    for category, subcategories in IMPRESSION_CATEGORIES.items():
        if subcategory in subcategories:
            return category
    return None


def validate_impression_tag(tag: dict) -> bool:
    """
    Валидация тега впечатления.

    Ожидаемый формат:
    {
        "category": "Сервис",
        "subcategory": "Вежливость/уважение",
        "sentiment": "positive"
    }
    """
    required_keys = {"category", "subcategory", "sentiment"}
    if not all(key in tag for key in required_keys):
        return False

    if tag["category"] not in IMPRESSION_CATEGORIES:
        return False

    if tag["subcategory"] not in IMPRESSION_CATEGORIES[tag["category"]]:
        return False

    valid_sentiments = [s[0] for s in SENTIMENT_CHOICES]
    if tag["sentiment"] not in valid_sentiments:
        return False

    return True
