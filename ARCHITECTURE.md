# Архитектура FeedbackQR

> Простота — высшая форма изощрённости

---

## Исследование конкурентов

### NetMonet — эталон минимализма
- Гостю не нужно приложение — всё через веб
- Один экран = одно действие
- Фото сотрудника + имя = доверие
- Быстрый выбор (2%, 5%, 10%) — меньше думать
- Push в Telegram админу

### Saby.ru — умный перехват негатива
- **Ключевая механика**: негативный отзыв → чат с менеджером (не публикуется)
- Все площадки в одном окне
- AI-тегирование автоматом
- Генерация ответов через AI

### Yext — масштаб и автоматизация
- Smart routing: отзывы направляются туда, где нужнее
- AI-ответы с возможностью редактирования (не полный автомат)
- Sentiment analysis — понимание тренда без чтения каждого отзыва
- 80+ интеграций с площадками

---

## Ключевые принципы

```
1. ОДИН ЭКРАН = ОДНО ДЕЙСТВИЕ
   Гость не должен скроллить и думать

2. ПЕРЕХВАТ НЕГАТИВА
   Плохой отзыв → диалог с менеджером, не публикация

3. AI КАК ПОМОЩНИК
   Черновики ответов, теги, sentiment — но человек решает

4. МИНИМУМ СУЩНОСТЕЙ
   Если можно объединить — объединяем
```

---

## 1. Упрощённая модель данных

### Было: 6 сущностей для структуры → Стало: 3

```
┌─────────────────────────────────────────────────────────────────┐
│                         Company                                  │
│  (Объединяем юрлицо + заведение, если одно заведение)          │
├─────────────────────────────────────────────────────────────────┤
│  id              UUID                                            │
│  name            VARCHAR(200)      "Кофейня Арбат"              │
│  slug            VARCHAR(50)       UNIQUE, для URL               │
│  address         VARCHAR(500)                                    │
│  city            VARCHAR(100)                                    │
│  phone           VARCHAR(20)                                     │
│  logo            ImageField                                      │
│  cover           ImageField        Фон для страницы отзыва      │
│  settings        JSONField         { review_form: {...} }       │
│  is_chain        BOOLEAN           Это сеть? (для будущего)     │
│  is_active       BOOLEAN                                         │
│  created_at      DATETIME                                        │
└─────────────────────────────────────────────────────────────────┘
                              │
                              │ 1:N (опционально)
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                          Spot                                    │
│  (Точка размещения QR: стол, стойка, вход)                     │
├─────────────────────────────────────────────────────────────────┤
│  id              UUID                                            │
│  company         FK(Company)                                     │
│  name            VARCHAR(50)       "Стол 5" или "Барная стойка" │
│  zone            VARCHAR(50)       "Терраса", "Зал" (опционально)│
│  qr_code         OneToOne(QR)      Один QR на точку             │
│  is_active       BOOLEAN                                         │
└─────────────────────────────────────────────────────────────────┘
```

### QR-код — минимум полей

```
┌─────────────────────────────────────────────────────────────────┐
│                            QR                                    │
├─────────────────────────────────────────────────────────────────┤
│  id              UUID                                            │
│  code            VARCHAR(8)        UNIQUE "A1B2C3D4" (короткий) │
│  company         FK(Company)                                     │
│  spot            FK(Spot)          nullable                      │
│  │                                                               │
│  # Статика — никогда не меняется                                │
│  # URL: https://fbqr.ru/A1B2C3D4                                │
│  │                                                               │
│  # Кастомизация                                                 │
│  color           VARCHAR(7)        "#000000"                     │
│  logo            ImageField        nullable                      │
│  image           ImageField        Готовая картинка             │
│  │                                                               │
│  scans           INTEGER           default=0                     │
│  is_active       BOOLEAN                                         │
│  created_at      DATETIME                                        │
└─────────────────────────────────────────────────────────────────┘
```

### Пользователи — 3 роли вместо 6

```
┌─────────────────────────────────────────────────────────────────┐
│                           User                                   │
│  (Расширяем Django AbstractUser)                                │
├─────────────────────────────────────────────────────────────────┤
│  # Стандартные поля                                             │
│  id, email, password, first_name, last_name                     │
│  │                                                               │
│  phone           VARCHAR(20)                                     │
│  avatar          ImageField                                      │
│  telegram_id     BIGINT            Для уведомлений              │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                          Member                                  │
│  (Связь пользователя с компанией)                              │
├─────────────────────────────────────────────────────────────────┤
│  id              UUID                                            │
│  user            FK(User)                                        │
│  company         FK(Company)                                     │
│  role            ENUM              'owner'|'manager'|'viewer'   │
│  is_active       BOOLEAN                                         │
└─────────────────────────────────────────────────────────────────┘

РОЛИ (только 3):
┌────────────┬────────────────────────────────────────────────────┐
│ owner      │ Всё: настройки, биллинг, команда, отзывы          │
├────────────┼────────────────────────────────────────────────────┤
│ manager    │ Отзывы: просмотр, ответы, теги. QR-коды.          │
├────────────┼────────────────────────────────────────────────────┤
│ viewer     │ Только чтение: статистика, отзывы                 │
└────────────┴────────────────────────────────────────────────────┘
```

### Отзывы — единая модель

```
┌─────────────────────────────────────────────────────────────────┐
│                          Review                                  │
│  (Все отзывы: и наши, и внешние)                               │
├─────────────────────────────────────────────────────────────────┤
│  id              UUID                                            │
│  company         FK(Company)                                     │
│  │                                                               │
│  # Источник                                                     │
│  source          ENUM              'internal'|'yandex'|'2gis'|  │
│                                    'google'|'tripadvisor'       │
│  external_id     VARCHAR(100)      nullable, ID на площадке     │
│  external_url    VARCHAR(500)      nullable                      │
│  │                                                               │
│  # Привязка (только для internal)                               │
│  spot            FK(Spot)          nullable                      │
│  qr              FK(QR)            nullable                      │
│  │                                                               │
│  # Автор                                                        │
│  author_name     VARCHAR(100)      "Мария" или "Аноним"         │
│  author_contact  VARCHAR(200)      email/телефон, nullable      │
│  │                                                               │
│  # Контент                                                      │
│  rating          SMALLINT          1-5 звёзд                     │
│  text            TEXT              nullable                      │
│  │                                                               │
│  # Детальные оценки (для internal)                              │
│  ratings         JSONField         {"food": 1, "service": 0}    │
│                                    # 1=like, 0=dislike, null=skip│
│  │                                                               │
│  # AI-анализ                                                    │
│  sentiment       ENUM              'positive'|'neutral'|        │
│                                    'negative'                    │
│  sentiment_score DECIMAL(3,2)      -1.00 до +1.00               │
│  tags            JSONField         ["долгое ожидание", "вкусно"]│
│  │                                                               │
│  # Статус и модерация                                           │
│  status          ENUM              'new'|'in_progress'|         │
│                                    'resolved'|'archived'        │
│  is_public       BOOLEAN           Показывать на виджете?       │
│  │                                                               │
│  # Ответ                                                        │
│  response        TEXT              nullable                      │
│  response_at     DATETIME          nullable                      │
│  response_by     FK(User)          nullable                      │
│  │                                                               │
│  created_at      DATETIME                                        │
│  platform_date   DATETIME          Дата на площадке (для внешних)│
└─────────────────────────────────────────────────────────────────┘
```

### Внешние площадки — минимум

```
┌─────────────────────────────────────────────────────────────────┐
│                        Platform                                  │
│  (Справочник: Яндекс, 2GIS, Google)                            │
├─────────────────────────────────────────────────────────────────┤
│  id              VARCHAR(20)       PK: 'yandex', '2gis', etc    │
│  name            VARCHAR(50)       "Яндекс Карты"               │
│  icon            VARCHAR(50)       Имя иконки                   │
│  is_active       BOOLEAN                                         │
└─────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────┐
│                       Connection                                 │
│  (Привязка компании к площадке)                                │
├─────────────────────────────────────────────────────────────────┤
│  id              UUID                                            │
│  company         FK(Company)                                     │
│  platform        FK(Platform)                                    │
│  external_id     VARCHAR(100)      ID на площадке               │
│  external_url    VARCHAR(500)      Ссылка на профиль            │
│  sync_enabled    BOOLEAN                                         │
│  last_sync       DATETIME          nullable                      │
│  │                                                               │
│  UNIQUE(company, platform)                                       │
└─────────────────────────────────────────────────────────────────┘
```

---

## 2. Гостевой интерфейс (как NetMonet)

### Принцип: один экран — одно действие

```
ЭКРАН 1: Приветствие
┌─────────────────────────────────────┐
│                                     │
│         [Лого заведения]            │
│                                     │
│         Кофейня "Арбат"             │
│         Стол 5                      │
│                                     │
│    ─────────────────────────────    │
│                                     │
│         Как вам у нас?              │
│                                     │
│         ★ ★ ★ ★ ★                  │
│         (тап по звезде)             │
│                                     │
└─────────────────────────────────────┘

        ↓ после выбора звёзд ↓

ЭКРАН 2A: Если 4-5 звёзд (позитив)
┌─────────────────────────────────────┐
│                                     │
│     Спасибо! Что понравилось?       │
│                                     │
│     [Еда]  [Сервис]  [Атмосфера]   │
│     (мульти-выбор, опционально)     │
│                                     │
│     Хотите добавить пару слов?      │
│     ┌─────────────────────────┐     │
│     │ Всё было отлично!       │     │
│     └─────────────────────────┘     │
│                                     │
│     ┌─────────────────────────┐     │
│     │      ОТПРАВИТЬ          │     │
│     └─────────────────────────┘     │
│                                     │
│     Оставить отзыв на Яндекс? →     │
│                                     │
└─────────────────────────────────────┘

ЭКРАН 2B: Если 1-3 звезды (негатив) — ПЕРЕХВАТ
┌─────────────────────────────────────┐
│                                     │
│     Нам очень жаль!                 │
│                                     │
│     Расскажите, что пошло не так?  │
│     Мы хотим исправиться.           │
│                                     │
│     ┌─────────────────────────┐     │
│     │                         │     │
│     │                         │     │
│     │                         │     │
│     └─────────────────────────┘     │
│                                     │
│     Как с вами связаться?           │
│     (чтобы сообщить о решении)      │
│                                     │
│     [___телефон или email___]       │
│                                     │
│     ┌─────────────────────────┐     │
│     │      ОТПРАВИТЬ          │     │
│     └─────────────────────────┘     │
│                                     │
└─────────────────────────────────────┘

        ↓ Негатив НЕ публикуется ↓
        ↓ Идёт напрямую менеджеру ↓

ЭКРАН 3: Спасибо
┌─────────────────────────────────────┐
│                                     │
│              ✓                      │
│                                     │
│         Спасибо за отзыв!           │
│                                     │
│     Ваше мнение помогает нам        │
│     становиться лучше.              │
│                                     │
│                                     │
│         [Закрыть]                   │
│                                     │
└─────────────────────────────────────┘
```

### Механика перехвата негатива (как Saby)

```
Гость ставит 1-3 звезды
         │
         ▼
┌─────────────────────────┐
│  Показываем форму       │
│  "Что пошло не так?"    │
│  + поле для контакта    │
└───────────┬─────────────┘
            │
            ▼
    Review.is_public = False
    Review.status = 'new'
    Review.sentiment = 'negative'
            │
            ▼
┌─────────────────────────┐
│  Уведомление менеджеру  │
│  (Telegram / Email)     │
│  "Негативный отзыв!"    │
└───────────┬─────────────┘
            │
            ▼
    Менеджер связывается
    с гостем лично
            │
            ▼
    Проблема решена →
    Review.status = 'resolved'
```

**Результат**: негатив не попадает в публичное пространство, а решается лично.

---

## 3. Дашборд — минимализм

### Главный экран (один взгляд = вся картина)

```
┌─────────────────────────────────────────────────────────────────┐
│  FeedbackQR          Кофейня "Арбат"            👤 Иван        │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐        │
│  │   4.6    │  │    23    │  │     5    │  │   312    │        │
│  │  рейтинг │  │  новых   │  │ негатив  │  │  сканов  │        │
│  │  ↑ 0.2   │  │ отзывов  │  │ ⚠️       │  │  за мес  │        │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘        │
│                                                                  │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│                                                                  │
│  ТРЕБУЮТ ВНИМАНИЯ                                               │
│  ───────────────────────────────────────────────────────────    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ ★★☆☆☆  "Ждали 40 минут"                    2 часа назад│    │
│  │ 📞 +7 999 123-45-67                         [Ответить] │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ ★★★☆☆  "Холодный кофе"                     5 часов назад│    │
│  │ 📧 maria@mail.ru                            [Ответить] │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│                                                                  │
│  ПОСЛЕДНИЕ ОТЗЫВЫ                          [Все отзывы →]       │
│  ───────────────────────────────────────────────────────────    │
│                                                                  │
│  ★★★★★  Очень вкусно!               Яндекс     12 янв        │
│  ★★★★☆  Хороший кофе, но шумно     Наш         12 янв        │
│  ★★★★★  Приду ещё!                  2GIS       11 янв        │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

### Навигация — 4 пункта вместо 7

```
┌──────────────────────────────────────┐
│  [Обзор]  [Отзывы]  [QR]  [Настройки]│
└──────────────────────────────────────┘

Обзор     — Главный дашборд (см. выше)
Отзывы    — Все отзывы + фильтры
QR        — Управление QR-кодами и точками
Настройки — Компания, команда, интеграции
```

### Страница отзывов — фокус на действии

```
┌─────────────────────────────────────────────────────────────────┐
│  ОТЗЫВЫ                                                         │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │ [Все] [Новые •5] [Негатив •2] [Без ответа •8]          │    │
│  │                                                          │    │
│  │ Источник: [Все ▼]    Период: [Месяц ▼]    🔍 Поиск     │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  ★★☆☆☆  Ждали заказ очень долго                         │    │
│  │  👤 Аноним  •  Стол 5  •  Наш сервис  •  2 часа назад   │    │
│  │                                                          │    │
│  │  "Пришли пообедать, но еду несли 40 минут.              │    │
│  │   Официант извинился, но осадок остался."               │    │
│  │                                                          │    │
│  │  🏷️ ожидание, сервис                                    │    │
│  │                                                          │    │
│  │  ┌─────────────────────────────────────────────────┐    │    │
│  │  │ Ваш ответ...                                    │    │    │
│  │  │                                                  │    │    │
│  │  │ [🤖 Сгенерировать]              [Отправить]     │    │    │
│  │  └─────────────────────────────────────────────────┘    │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
│  ┌─────────────────────────────────────────────────────────┐    │
│  │                                                          │    │
│  │  ★★★★★  Лучший кофе в городе!                           │    │
│  │  👤 Мария К.  •  Яндекс Карты  •  5 часов назад         │    │
│  │                                                          │    │
│  │  "Уютная атмосфера, вкусные десерты. Рекомендую!"       │    │
│  │                                                          │    │
│  │  🏷️ атмосфера, еда, позитив                             │    │
│  │                                                          │    │
│  │  💬 Ваш ответ: "Мария, спасибо за тёплые слова!..."     │    │
│  │     ✓ Опубликован на Яндекс                             │    │
│  │                                                          │    │
│  └─────────────────────────────────────────────────────────┘    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 4. AI-функции (как Yext)

### Автоматический анализ при поступлении отзыва

```python
# При сохранении нового Review

async def analyze_review(review: Review):
    """AI анализирует отзыв и заполняет поля"""

    result = await ai.analyze(review.text, review.rating)

    review.sentiment = result.sentiment        # 'positive'/'negative'/'neutral'
    review.sentiment_score = result.score      # -1.0 ... +1.0
    review.tags = result.tags                  # ['ожидание', 'сервис']

    # Определяем публичность
    if review.source == 'internal' and review.rating <= 3:
        review.is_public = False  # Негатив не публикуем

    review.save()

    # Уведомляем если негатив
    if review.sentiment == 'negative':
        await notify_managers(review, priority='high')
```

### Генерация ответа (драфт, не автомат)

```python
async def generate_response_draft(review: Review) -> str:
    """AI генерирует черновик ответа для редактирования"""

    prompt = f"""
    Напиши вежливый ответ на отзыв клиента.
    Рейтинг: {review.rating}/5
    Текст: {review.text}
    Заведение: {review.company.name}

    Правила:
    - Коротко (2-3 предложения)
    - Поблагодари за отзыв
    - Если негатив — извинись и предложи решение
    - Подпись: "Команда {review.company.name}"
    """

    return await ai.generate(prompt)
```

### Smart routing для позитивных отзывов (как Yext)

```
Гость поставил 5 звёзд
         │
         ▼
┌─────────────────────────────┐
│  Спасибо! Вам понравилось?  │
│                             │
│  Поделитесь на площадке:    │
│                             │
│  [⭐ Яндекс]  [⭐ Google]   │
│                             │
│  (ведёт на страницу отзыва  │
│   с предзаполненным текстом)│
└─────────────────────────────┘
```

Так мы направляем довольных клиентов оставлять публичные отзывы.

---

## 5. Структура Django-приложений (упрощённая)

```
qrservice/
├── manage.py
├── requirements.txt
│
├── config/                     # Настройки
│   ├── settings.py
│   ├── urls.py
│   └── wsgi.py
│
├── apps/
│   ├── accounts/              # Пользователи
│   │   ├── models.py          # User, Member
│   │   └── views.py
│   │
│   ├── companies/             # Компании и точки
│   │   ├── models.py          # Company, Spot
│   │   └── views.py
│   │
│   ├── qr/                    # QR-коды
│   │   ├── models.py          # QR
│   │   ├── views.py           # Редирект, генерация
│   │   └── services.py
│   │
│   ├── reviews/               # Отзывы (всё в одном!)
│   │   ├── models.py          # Review
│   │   ├── views.py
│   │   ├── forms.py           # Гостевая форма
│   │   └── services/
│   │       ├── ai.py          # Анализ, генерация
│   │       └── sync.py        # Синхронизация с площадками
│   │
│   └── dashboard/             # Админка
│       └── views.py
│
├── templates/
│   ├── base.html
│   ├── guest/                 # Публичные страницы
│   │   └── review_form.html
│   └── dashboard/             # Админка
│       ├── index.html
│       ├── reviews.html
│       └── qr.html
│
└── static/
    └── css/
        └── style.css          # Один файл!
```

**Было**: 8 приложений → **Стало**: 5

---

## 6. API (минимум эндпоинтов)

```
# Публичные
GET  /{code}                      → Редирект QR
GET  /f/{company_slug}            → Форма отзыва
GET  /f/{company_slug}/{spot_id}  → Форма с привязкой к точке
POST /api/reviews/                → Отправить отзыв

# Авторизованные (dashboard)
GET  /api/stats/                  → Статистика для дашборда
GET  /api/reviews/                → Список отзывов (фильтры)
POST /api/reviews/{id}/respond/   → Ответить на отзыв
POST /api/reviews/{id}/ai-draft/  → Сгенерировать черновик ответа

GET  /api/qr/                     → Список QR
POST /api/qr/                     → Создать QR
GET  /api/qr/{id}/download/       → Скачать картинку

POST /api/sync/{platform}/        → Запустить синхронизацию
```

---

## 7. Технологии

```
Backend:          Django 5 + DRF
Frontend:         Django Templates + HTMX + Alpine.js
                  (без React/Vue — проще)
AI:               Claude API (анализ, генерация)
База:             PostgreSQL (prod) / SQLite (dev)
Фон:              Celery + Redis
Уведомления:      Telegram Bot API
```

---

## 8. Этапы разработки

### Фаза 1: MVP (2 недели)
- [ ] Модели: Company, Spot, QR, Review, User, Member
- [ ] Гостевая форма отзыва (минималистичная)
- [ ] QR-редирект
- [ ] Базовый дашборд (список отзывов)
- [ ] Ответы на отзывы

### Фаза 2: Умные функции
- [ ] AI-анализ тональности
- [ ] Автотеги
- [ ] Генерация черновиков ответов
- [ ] Перехват негатива (отдельный флоу)
- [ ] Telegram-уведомления

### Фаза 3: Интеграции
- [ ] Синхронизация с Яндекс Картами
- [ ] Синхронизация с 2GIS
- [ ] Smart routing позитивных отзывов

### Фаза 4: Масштабирование
- [ ] Поддержка сетей (несколько заведений)
- [ ] Расширенная аналитика
- [ ] Биллинг

---

## 9. Сравнение: было → стало

| Аспект | Было | Стало |
|--------|------|-------|
| Модели | 17 | 8 |
| Роли | 6 | 3 |
| Django apps | 8 | 5 |
| Экраны формы | 1 сложный | 3 простых |
| Пункты меню | 7 | 4 |

**Ключевое изменение**: вместо "всё на одном экране" — "один экран = одно действие".

---

## Источники вдохновения

- [NetMonet](https://netmonet.co) — минимализм интерфейса
- [Saby Rating](https://saby.ru/target/rating) — перехват негатива
- [Yext Reviews](https://www.yext.com/platform/reviews) — AI и автоматизация
